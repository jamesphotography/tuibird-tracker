{% extends "base.html" %}

{% block title %}设置 - 图忆鸟讯{% endblock %}

{% block content %}
<div class="settings-container">
    <h1 class="page-title">
        <i class="bi bi-gear-fill"></i> 设置
    </h1>

    <!-- 访客模式提示 -->
    <div class="settings-card visitor-mode-card" id="visitorModeCard" style="display: none;">
        <h2 class="card-title">
            <i class="bi bi-person-badge"></i> 访客模式
        </h2>

        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <strong>您正在使用访客模式</strong>
        </div>

        <div class="usage-stats" id="usageStats">
            <div class="stat-item">
                <div class="stat-label">今日剩余查询</div>
                <div class="stat-value" id="dailyRemaining">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">本小时剩余</div>
                <div class="stat-value" id="hourlyRemaining">-</div>
            </div>
        </div>

        <div class="visitor-limits">
            <h3>访客模式限制：</h3>
            <ul>
                <li>每小时最多 <strong>10</strong> 次查询</li>
                <li>每天最多 <strong>30</strong> 次查询</li>
                <li>单次最多查询 <strong>1</strong> 个物种</li>
                <li>最大搜索半径 <strong>25</strong> km</li>
                <li>最大查询天数 <strong>7</strong> 天</li>
            </ul>
        </div>

        <div class="upgrade-prompt">
            <p><i class="bi bi-gift-fill"></i> 注册免费的 eBird API Key 即可解除所有限制！</p>
            <a href="https://ebird.org/api/keygen" target="_blank" class="btn btn-primary">
                <i class="bi bi-key-fill"></i> 免费获取 API Key
            </a>
        </div>
    </div>

    <!-- API Key 配置 -->
    <div class="settings-card">
        <h2 class="card-title">
            <i class="bi bi-key-fill"></i> eBird API Key 配置
        </h2>

        <div class="api-key-status" id="apiKeyStatus">
            <div class="status-badge status-warning">
                <i class="bi bi-exclamation-triangle-fill"></i> 未配置
            </div>
            <p class="text-muted">您还没有配置 eBird API Key，无法使用追踪功能。</p>
        </div>

        <div class="alert alert-info">
            <i class="bi bi-shield-lock-fill"></i>
            <strong>隐私保护：</strong>您的 API Key 仅保存在浏览器本地存储中，不会上传到服务器。每次请求时直接使用您的 Key 调用 eBird API。
        </div>

        <div class="api-key-form">
            <div class="form-group">
                <label class="form-label">API Key</label>
                <input type="text"
                       id="apiKeyInput"
                       class="form-control"
                       placeholder="请输入您的 eBird API Key">
            </div>

            <div class="form-actions">
                <button onclick="saveApiKey()" class="btn btn-primary">
                    <i class="bi bi-save"></i> 保存到本地
                </button>
                <button onclick="testApiKey()" class="btn btn-secondary">
                    <i class="bi bi-check-circle"></i> 验证 API Key
                </button>
                <button onclick="deleteApiKey()" class="btn btn-danger" id="deleteBtn" style="display: none;">
                    <i class="bi bi-trash"></i> 清除本地存储
                </button>
            </div>
        </div>

        <div class="api-key-guide">
            <h3>如何获取 API Key？</h3>
            <ol>
                <li>访问 <a href="https://ebird.org/api/keygen" target="_blank">eBird API Key 申请页面</a></li>
                <li>登录您的 eBird 账户（如果没有账户，需要先注册）</li>
                <li>填写申请表单，说明用途为 "Personal bird tracking tool"</li>
                <li>提交后会立即收到 API Key，复制并粘贴到上方输入框</li>
            </ol>
            <p class="text-muted">
                <i class="bi bi-info-circle"></i>
                API Key 通常为 10-15 位的字母数字组合，请妥善保管。
            </p>
        </div>
    </div>

    <!-- 关于信息 -->
    <div class="settings-card">
        <h2 class="card-title">
            <i class="bi bi-info-circle-fill"></i> 关于
        </h2>
        <div class="about-info">
            <p><strong>版本:</strong> {{ version }}</p>
            <p><strong>构建日期:</strong> {{ build_date }}</p>
            <p><strong>数据来源:</strong> <a href="https://ebird.org" target="_blank">eBird.org</a></p>
            <p><strong>项目主页:</strong> <a href="https://github.com/yourusername/tuibird-tracker" target="_blank">GitHub</a></p>
        </div>
    </div>
</div>

<style>
.settings-container {
    max-width: 800px;
    margin: 0 auto;
}

.page-title {
    font-size: 2.5rem;
    margin-bottom: 2rem;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 1rem;
}

.settings-card {
    background: var(--card-bg);
    padding: 2rem;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    margin-bottom: 2rem;
}

.card-title {
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.api-key-status {
    margin-bottom: 2rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 500;
    margin-bottom: 1rem;
}

.status-success {
    background: #d4edda;
    color: #155724;
}

.status-warning {
    background: #fff3cd;
    color: #856404;
}

.current-key {
    margin: 0;
}

.current-key code {
    background: #e9ecef;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
}

.form-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.api-key-guide {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border-color);
}

.api-key-guide h3 {
    color: var(--primary-color);
    margin-bottom: 1rem;
}

.api-key-guide ol {
    padding-left: 1.5rem;
}

.api-key-guide li {
    margin-bottom: 0.5rem;
}

.about-info p {
    margin-bottom: 0.5rem;
}

.alert {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
}

.alert i {
    font-size: 1.2rem;
    flex-shrink: 0;
}

.alert-info {
    background-color: #e7f3ff;
    border: 1px solid #b3d9ff;
    color: #004085;
}

.alert-info i {
    color: #0066cc;
}

.alert-warning {
    background-color: #fff3cd;
    border: 1px solid #ffecb5;
    color: #856404;
}

.visitor-mode-card {
    background: linear-gradient(135deg, #FFF9E6 0%, #FFF3CD 100%);
    border: 2px solid #FFE5A3;
}

.usage-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin: 1.5rem 0;
}

.stat-item {
    background: white;
    padding: 1rem;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.stat-label {
    font-size: 0.85rem;
    color: var(--text-light);
    margin-bottom: 0.5rem;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    background: linear-gradient(135deg, #546E7A 0%, #66BB6A 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.visitor-limits {
    margin: 1.5rem 0;
}

.visitor-limits h3 {
    color: var(--primary-color);
    font-size: 1.1rem;
    margin-bottom: 0.75rem;
}

.visitor-limits ul {
    list-style: none;
    padding: 0;
}

.visitor-limits li {
    padding: 0.5rem 0;
    padding-left: 1.5rem;
    position: relative;
}

.visitor-limits li::before {
    content: '•';
    position: absolute;
    left: 0.5rem;
    color: var(--accent-color);
    font-weight: bold;
}

.upgrade-prompt {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    text-align: center;
    margin-top: 1.5rem;
}

.upgrade-prompt p {
    margin-bottom: 1rem;
    font-size: 1.05rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// 页面加载时检查本地存储的 API Key 和访客状态
document.addEventListener('DOMContentLoaded', function() {
    updateApiKeyStatus();
    updateVisitorStatus();
});

// 更新 API Key 状态显示
function updateApiKeyStatus() {
    const apiKey = getLocalApiKey();
    const statusDiv = document.getElementById('apiKeyStatus');
    const deleteBtn = document.getElementById('deleteBtn');
    const inputField = document.getElementById('apiKeyInput');

    if (apiKey) {
        // 已配置
        const maskedKey = `${apiKey.substring(0, 4)}...${apiKey.substring(apiKey.length - 4)}`;
        statusDiv.innerHTML = `
            <div class="status-badge status-success">
                <i class="bi bi-check-circle-fill"></i> 已配置（本地存储）
            </div>
            <p class="current-key">当前 API Key: <code>${maskedKey}</code></p>
        `;
        deleteBtn.style.display = 'inline-block';
        inputField.value = '';  // 清空输入框
        inputField.placeholder = '已配置 API Key，如需更换请输入新的 Key';
    } else {
        // 未配置
        statusDiv.innerHTML = `
            <div class="status-badge status-warning">
                <i class="bi bi-exclamation-triangle-fill"></i> 未配置
            </div>
            <p class="text-muted">您还没有配置 eBird API Key，无法使用追踪功能。</p>
        `;
        deleteBtn.style.display = 'none';
        inputField.placeholder = '请输入您的 eBird API Key';
    }
}

// 保存 API Key 到本地存储
function saveApiKey() {
    const apiKey = document.getElementById('apiKeyInput').value.trim();

    if (!apiKey) {
        showNotification('请输入 API Key', 'warning');
        return;
    }

    // 简单验证格式（eBird API Key 通常是字母数字组合）
    if (apiKey.length < 8) {
        showNotification('API Key 格式不正确，长度过短', 'error');
        return;
    }

    // 保存到 localStorage
    saveLocalApiKey(apiKey);
    showNotification('API Key 已保存到浏览器本地存储！', 'success');

    // 更新状态显示
    setTimeout(() => {
        updateApiKeyStatus();
    }, 500);
}

// 验证 API Key
async function testApiKey() {
    const apiKey = getLocalApiKey();

    if (!apiKey) {
        showNotification('请先保存 API Key', 'warning');
        return;
    }

    try {
        showNotification('正在验证 API Key...', 'info');

        // 方案1: 尝试直接调用 eBird API 验证（可能受 CORS 限制）
        try {
            const response = await fetch('https://api.ebird.org/v2/ref/taxonomy/ebird?fmt=json&locale=zh', {
                headers: {
                    'X-eBird-API-Key': apiKey
                }
            });

            if (response.ok) {
                showNotification('✅ API Key 验证成功！', 'success');
                return;
            } else if (response.status === 401) {
                showNotification('❌ API Key 无效，请检查后重新输入', 'error');
                return;
            } else {
                showNotification(`验证失败: HTTP ${response.status}`, 'error');
                return;
            }
        } catch (corsError) {
            // CORS 错误，使用备选方案
            console.log('直接验证失败（CORS），尝试通过服务器验证', corsError);
        }

        // 方案2: 通过我们的服务器转发验证请求
        const serverResponse = await apiRequest('/api/validate-key', {
            method: 'POST',
            body: JSON.stringify({ api_key: apiKey })
        });

        if (serverResponse.valid) {
            showNotification('✅ API Key 验证成功！', 'success');
        } else {
            showNotification('❌ API Key 无效：' + (serverResponse.error || '请检查后重新输入'), 'error');
        }
    } catch (error) {
        showNotification('验证失败: ' + error.message, 'error');
    }
}

// 删除本地存储的 API Key
function deleteApiKey() {
    if (!confirm('确定要清除本地存储的 API Key 吗？清除后将无法使用追踪功能。')) {
        return;
    }

    removeLocalApiKey();
    showNotification('API Key 已从本地存储中清除', 'success');

    // 更新状态显示
    setTimeout(() => {
        updateApiKeyStatus();
        updateVisitorStatus();
    }, 500);
}

// 更新访客模式状态
async function updateVisitorStatus() {
    try {
        const data = await apiRequest('/api/usage-status');
        const visitorCard = document.getElementById('visitorModeCard');

        if (data.is_anonymous) {
            // 显示访客模式卡片
            visitorCard.style.display = 'block';

            // 更新使用统计
            document.getElementById('dailyRemaining').textContent = data.usage.daily_remaining;
            document.getElementById('hourlyRemaining').textContent = data.usage.hourly_remaining;
        } else {
            // 隐藏访客模式卡片
            visitorCard.style.display = 'none';
        }
    } catch (error) {
        console.error('获取访客状态失败:', error);
    }
}
</script>
{% endblock %}
