{% extends "base.html" %}

{% block title %}ç‰©ç§è¿½è¸ª - æ…§çœ¼æ‰¾é¸Ÿ{% endblock %}

{% block content %}
<div class="tracker-container">
    <h1 class="page-title">
        <i class="bi bi-bullseye"></i> ç‰©ç§è¿½è¸ª
    </h1>

    <div class="tracker-card">
        <div class="mode-selector">
            <h2>é€‰æ‹©è¿½è¸ªæ¨¡å¼</h2>
            <div class="mode-buttons">
                <button onclick="selectMode('single')" class="mode-btn active" id="singleModeBtn">
                    <i class="bi bi-search"></i>
                    <div>å•ç‰©ç§è¿½è¸ª</div>
                    <small>æ·±åº¦è¿½è¸ªå•ä¸ªé¸Ÿç§</small>
                </button>
                <button onclick="selectMode('multi')" class="mode-btn" id="multiModeBtn">
                    <i class="bi bi-collection-fill"></i>
                    <div>å¤šç‰©ç§åˆ†æ</div>
                    <small>åŒæ—¶è¿½è¸ªå¤šä¸ªé¸Ÿç§</small>
                </button>
            </div>
        </div>

        <!-- ç‰©ç§æœç´¢ -->
        <div class="form-group">
            <label class="form-label">
                <i class="bi bi-search"></i> æœç´¢é¸Ÿç§
                <span class="text-muted">ï¼ˆæ”¯æŒä¸­è‹±æ–‡ï¼‰</span>
            </label>
            <input type="text"
                   id="speciesSearch"
                   class="form-control"
                   placeholder="è¾“å…¥é¸Ÿç§åç§°ï¼Œå¦‚ï¼šä¸ƒå½©æ–‡é¸Ÿã€Gouldian Finch"
                   oninput="searchSpecies(this.value)">
        </div>

        <!-- æœç´¢ç»“æœ -->
        <div id="searchResults" class="search-results" style="display: none;"></div>

        <!-- å·²é€‰æ‹©çš„ç‰©ç§ -->
        <div id="selectedSpecies" class="selected-species" style="display: none;">
            <h3>å·²é€‰æ‹©çš„ç‰©ç§</h3>
            <div id="selectedList" class="selected-list"></div>
        </div>

        <!-- æŸ¥è¯¢å‚æ•° -->
        <div class="query-params">
            <h3>æŸ¥è¯¢å‚æ•°</h3>

            <div class="form-group">
                <label class="form-label">
                    <i class="bi bi-diagram-3"></i> å¤šç‰©ç§åˆ†ææ¨¡å¼
                    <small class="text-muted">(ä»…åœ¨é€‰æ‹©å¤šä¸ªç‰©ç§æ—¶ç”Ÿæ•ˆ)</small>
                </label>
                <select id="analysisMode" class="form-control">
                    <option value="and" selected>åŒæ—¶å‡ºç° - æŸ¥æ‰¾å¤šä¸ªç‰©ç§åœ¨åŒä¸€åœ°ç‚¹å…±åŒå‡ºç°çš„è®°å½• (æ¨èï¼Œé€Ÿåº¦å¿«)</option>
                    <option value="or">ä»»ä¸€ç‰©ç§ - åˆ†åˆ«æŸ¥è¯¢æ¯ä¸ªç‰©ç§çš„æ‰€æœ‰è§‚æµ‹è®°å½•</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">æœç´¢æ¨¡å¼</label>
                <select id="searchMode" class="form-control" onchange="toggleSearchMode()">
                    <option value="gps" selected>GPSæœç´¢ - æŒ‰åœ°ç‚¹åç§°æˆ–åæ ‡æŸ¥è¯¢</option>
                    <option value="region">åŒºåŸŸæœç´¢ - æŒ‰è¡Œæ”¿åŒºåŸŸæŸ¥è¯¢</option>
                </select>
            </div>

            <!-- GPSæœç´¢å‚æ•°ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰ -->
            <div id="gpsModeParams">
                <div class="form-group">
                    <label class="form-label">GPS åæ ‡æˆ–åœ°ç‚¹åç§°</label>
                    <div class="input-with-button">
                        <input type="text"
                               id="gpsLocation"
                               class="form-control"
                               placeholder="ä¾‹å¦‚: Darwin Waterfront æˆ– Kakadu National Park"
                               oninput="clearVerifiedCoordinates()">
                        <button type="button" onclick="verifyLocation()" class="btn btn-secondary btn-sm">
                            <i class="bi bi-search"></i> éªŒè¯åœ°å€
                        </button>
                    </div>
                    <small class="text-muted">
                        <i class="bi bi-lightbulb"></i>
                        <strong>åœ°ç‚¹ç¤ºä¾‹ï¼š</strong>åŸå¸‚å(Darwin)ã€åœ°æ ‡(Sydney Opera House)ã€å›½å®¶å…¬å›­(Kakadu National Park)ã€é‚®ç¼–åŒºåŸŸ(Darwin NT 0800)ã€æˆ–GPSåæ ‡(-12.4634, 130.8456)
                    </small>

                    <!-- éªŒè¯ç»“æœæ˜¾ç¤º -->
                    <div id="locationVerifyResult" style="display: none; margin-top: 0.75rem;">
                        <div class="alert alert-success">
                            <strong><i class="bi bi-check-circle"></i> åœ°å€éªŒè¯æˆåŠŸ</strong><br>
                            <span id="verifiedAddress"></span><br>
                            <small>GPSåæ ‡: <span id="verifiedCoords"></span></small>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="bi bi-circle"></i> æœç´¢åŠå¾„ (km)
                        </label>
                        <input type="range"
                               id="radius"
                               class="form-range"
                               min="1"
                               max="50"
                               value="25"
                               oninput="updateRadiusDisplay(this.value)">
                        <div class="range-display">
                            <span id="radiusDisplay">25</span> km
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ—¶é—´èŒƒå›´</label>
                        <select id="daysBackGPS" class="form-control">
                            <option value="7">æœ€è¿‘ 7 å¤©</option>
                            <option value="14" selected>æœ€è¿‘ 14 å¤©</option>
                            <option value="30">æœ€è¿‘ 30 å¤©</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- åŒºåŸŸæœç´¢å‚æ•° -->
            <div id="regionModeParams" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="bi bi-globe"></i> é€‰æ‹©å›½å®¶
                        </label>
                        <select id="countrySelect" class="form-control" onchange="loadRegions()">
                            <option value="">-- è¯·é€‰æ‹©å›½å®¶ --</option>
                        </select>
                        <small class="text-muted">
                            <i class="bi bi-lightbulb"></i> æ”¯æŒ 253 ä¸ªå›½å®¶å’Œåœ°åŒº
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ—¶é—´èŒƒå›´</label>
                        <select id="daysBack" class="form-control">
                            <option value="7">æœ€è¿‘ 7 å¤©</option>
                            <option value="14" selected>æœ€è¿‘ 14 å¤©</option>
                            <option value="30">æœ€è¿‘ 30 å¤©</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" id="regionSelectGroup" style="display: none;">
                    <label class="form-label">
                        <i class="bi bi-map"></i> é€‰æ‹©åŒºåŸŸ
                        <small class="text-muted">(å¯é€‰ï¼Œä¸é€‰åˆ™æŸ¥è¯¢æ•´ä¸ªå›½å®¶)</small>
                    </label>
                    <select id="regionCode" class="form-control">
                        <option value="">-- è¯·å…ˆé€‰æ‹©å›½å®¶ --</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="action-buttons">
            <button onclick="startTracking()" class="btn btn-primary btn-lg" id="trackBtn" disabled>
                <i class="bi bi-play-circle-fill"></i> å¼€å§‹è¿½è¸ª
            </button>
            <button onclick="clearSelection()" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> æ¸…ç©ºé€‰æ‹©
            </button>
        </div>
    </div>

    <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
    <div id="resultsArea" style="display: none;">
        <h2>è¿½è¸ªç»“æœ</h2>
        <div id="resultsContent"></div>
    </div>
</div>

<style>
.tracker-container {
    width: 100%;
    max-width: 100%;
    margin: 0;
    padding: 0 1rem;
}

.page-title {
    font-size: 2.5rem;
    margin-bottom: 2rem;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 1rem;
}

.tracker-card {
    background: var(--card-bg);
    padding: 2rem;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
}

.mode-selector {
    margin-bottom: 2rem;
}

.mode-selector h2 {
    font-size: 1.3rem;
    margin-bottom: 1rem;
    color: var(--primary-color);
}

.mode-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.mode-btn {
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
}

.mode-btn i {
    font-size: 2rem;
    display: block;
    margin-bottom: 0.5rem;
    color: var(--secondary-color);
}

.mode-btn div {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.mode-btn small {
    color: var(--text-light);
    font-size: 0.85rem;
}

.mode-btn:hover {
    border-color: var(--secondary-color);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.mode-btn.active {
    border-color: var(--primary-color);
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
}

.search-results {
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    max-height: 300px;
    overflow-y: auto;
    margin-top: 0.5rem;
}

.search-result-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
    transition: var(--transition);
}

.search-result-item:last-child {
    border-bottom: none;
}

.search-result-item:hover {
    background: #f8f9fa;
}

.search-result-item .cn-name {
    font-weight: 600;
    color: var(--text-dark);
}

.search-result-item .en-name {
    color: var(--text-light);
    font-size: 0.9rem;
}

.search-result-item .code {
    font-size: 0.85rem;
    color: var(--text-light);
    font-family: monospace;
}

.selected-species {
    margin: 1.5rem 0;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.selected-species h3 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
    color: var(--primary-color);
}

.selected-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.selected-tag {
    background: var(--primary-color);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.selected-tag button {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 0;
    font-size: 1.2rem;
    line-height: 1;
}

.query-params {
    margin: 2rem 0;
}

.query-params h3 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
    color: var(--primary-color);
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.action-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
}

/* ç»“æœæ‘˜è¦æ ·å¼ */
.result-summary {
    margin-top: 3rem;
}

.summary-card {
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    padding: 2rem;
    border-radius: 12px;
    border: 2px solid var(--success-color);
    display: flex;
    gap: 1.5rem;
    align-items: flex-start;
}

.summary-icon {
    font-size: 3rem;
    color: var(--success-color);
}

.summary-content {
    flex: 1;
}

.summary-content h3 {
    color: var(--success-color);
    margin-bottom: 1rem;
}

.summary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.stat-item {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
}

.stat-label {
    display: block;
    font-size: 0.85rem;
    color: var(--text-light);
    margin-bottom: 0.5rem;
}

.stat-value {
    display: block;
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary-color);
}

.summary-note {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
}

.range-display {
    text-align: center;
    margin-top: 0.5rem;
    font-weight: 600;
    color: var(--primary-color);
}

.form-range {
    width: 100%;
}

.input-with-button {
    display: flex;
    gap: 0.5rem;
}

.input-with-button .form-control {
    flex: 1;
}

.alert {
    padding: 0.75rem 1rem;
    border-radius: 8px;
    border: 1px solid;
}

.alert-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.alert-error {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let selectedMode = 'single';
let selectedSpeciesList = [];
let verifiedCoordinates = null;  // å­˜å‚¨éªŒè¯åçš„GPSåæ ‡

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰ä»endemicé¡µé¢ä¼ é€’è¿‡æ¥çš„æ•°æ®
document.addEventListener('DOMContentLoaded', async function() {
    // åŠ è½½å›½å®¶åˆ—è¡¨
    await loadCountries();

    const endemicData = localStorage.getItem('endemicTrackingData');

    if (endemicData) {
        try {
            const data = JSON.parse(endemicData);

            // å¦‚æœæœ‰é¸Ÿç§æ•°æ®
            if (data.birds && data.birds.length > 0) {
                // åˆ‡æ¢åˆ°å¤šç‰©ç§æ¨¡å¼
                if (data.birds.length > 1) {
                    selectMode('multi');
                }

                // æ˜¾ç¤ºæç¤º
                showNotification(`å·²ä»${data.country || 'ç‰¹æœ‰ç§æ£€ç´¢'}åŠ è½½ ${data.birds.length} ç§é¸Ÿï¼Œæ­£åœ¨æœç´¢é¸Ÿç§ä»£ç ...`, 'info');

                // æ‰¹é‡æœç´¢é¸Ÿç§ä»£ç ï¼Œä¼ é€’å®Œæ•´çš„data
                await loadBirdsByNames(data.birds, data.country, data);
            }

            // æ¸…é™¤localStorageä¸­çš„æ•°æ®ï¼ˆåªä½¿ç”¨ä¸€æ¬¡ï¼‰
            localStorage.removeItem('endemicTrackingData');
        } catch (error) {
            console.error('è§£æendemicæ•°æ®å¤±è´¥:', error);
        }
    }
});

// æ ¹æ®é¸Ÿååˆ—è¡¨åŠ è½½é¸Ÿç§
async function loadBirdsByNames(birdNames, countryName, endemicData) {
    for (const birdName of birdNames) {
        try {
            // æœç´¢é¸Ÿç§
            const data = await apiRequest('/api/search_species', {
                method: 'POST',
                body: JSON.stringify({ query: birdName })
            });

            if (data.results && data.results.length > 0) {
                // å–ç¬¬ä¸€ä¸ªåŒ¹é…ç»“æœ
                const bird = data.results[0];
                const code = bird.code || bird.ebird_code;

                // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©
                if (!selectedSpeciesList.find(s => s.code === code)) {
                    selectedSpeciesList.push({
                        code: code,
                        cn_name: bird.cn_name || bird.chinese_simplified,
                        en_name: bird.en_name || bird.english_name
                    });
                }
            }
        } catch (error) {
            console.error(`åŠ è½½é¸Ÿç§ ${birdName} å¤±è´¥:`, error);
        }
    }

    // æ›´æ–°æ˜¾ç¤º
    updateSelectedDisplay();

    // å¦‚æœæ¥è‡ªç‰¹æœ‰ç§é¡µé¢
    if (endemicData && endemicData.fromEndemic && endemicData.countryCode) {
        // åˆ‡æ¢åˆ°åŒºåŸŸæœç´¢æ¨¡å¼
        document.getElementById('searchMode').value = 'region';
        toggleSearchMode();

        // è‡ªåŠ¨é€‰æ‹©å›½å®¶
        document.getElementById('countrySelect').value = endemicData.countryCode;
        await loadRegions();

        showNotification(
            `å·²ä»${countryName}åŠ è½½ ${selectedSpeciesList.length} ç§é¸Ÿï¼Œè¯·é€‰æ‹©åŒºåŸŸåå¼€å§‹è¿½è¸ª`,
            'success'
        );
    } else if (countryName) {
        // æ™®é€šæƒ…å†µï¼Œå¡«å……åˆ°GPSæœç´¢æ¡†
        document.getElementById('gpsLocation').value = countryName;
        showNotification(`å·²åŠ è½½ ${selectedSpeciesList.length} ç§é¸Ÿï¼Œå»ºè®®è¾“å…¥å…·ä½“åœ°ç‚¹æˆ–è°ƒæ•´å›½å®¶åç§°åå¼€å§‹è¿½è¸ª`, 'success');
    } else {
        showNotification(`å·²åŠ è½½ ${selectedSpeciesList.length} ç§é¸Ÿï¼Œè¯·è¾“å…¥åœ°ç‚¹åå¼€å§‹è¿½è¸ª`, 'success');
    }
}

function selectMode(mode) {
    selectedMode = mode;

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.getElementById('singleModeBtn').classList.toggle('active', mode === 'single');
    document.getElementById('multiModeBtn').classList.toggle('active', mode === 'multi');

    // å•ç‰©ç§æ¨¡å¼ä¸‹è‡ªåŠ¨æ¸…ç©ºå¤šé€‰
    if (mode === 'single' && selectedSpeciesList.length > 1) {
        selectedSpeciesList = [];
        updateSelectedDisplay();
    }
}

// åˆ‡æ¢æœç´¢æ¨¡å¼
function toggleSearchMode() {
    const searchMode = document.getElementById('searchMode').value;
    const regionParams = document.getElementById('regionModeParams');
    const gpsParams = document.getElementById('gpsModeParams');

    if (searchMode === 'region') {
        regionParams.style.display = 'block';
        gpsParams.style.display = 'none';
    } else {
        regionParams.style.display = 'none';
        gpsParams.style.display = 'block';
    }
}

// æ›´æ–°åŠå¾„æ˜¾ç¤º
function updateRadiusDisplay(value) {
    document.getElementById('radiusDisplay').textContent = value;
}

// æ¸…é™¤å·²éªŒè¯çš„åæ ‡ï¼ˆå½“ç”¨æˆ·ä¿®æ”¹è¾“å…¥æ¡†æ—¶ï¼‰
function clearVerifiedCoordinates() {
    verifiedCoordinates = null;
    const resultDiv = document.getElementById('locationVerifyResult');
    if (resultDiv) {
        resultDiv.style.display = 'none';
    }
}

// éªŒè¯åœ°å€
async function verifyLocation() {
    const gpsLocation = document.getElementById('gpsLocation').value.trim();
    const resultDiv = document.getElementById('locationVerifyResult');

    if (!gpsLocation) {
        showNotification('è¯·è¾“å…¥åœ°ç‚¹åç§°æˆ–GPSåæ ‡', 'warning');
        return;
    }

    try {
        showNotification('æ­£åœ¨éªŒè¯åœ°å€...', 'info');

        const data = await apiRequest('/api/geocode', {
            method: 'POST',
            body: JSON.stringify({ place_name: gpsLocation })
        });

        if (data.success) {
            // ä¿å­˜éªŒè¯åçš„GPSåæ ‡
            verifiedCoordinates = {
                latitude: data.latitude,
                longitude: data.longitude
            };

            // æ˜¾ç¤ºéªŒè¯æˆåŠŸç»“æœ
            document.getElementById('verifiedAddress').textContent = data.display_name;
            document.getElementById('verifiedCoords').textContent =
                `${data.latitude.toFixed(4)}, ${data.longitude.toFixed(4)}`;

            resultDiv.querySelector('.alert').className = 'alert alert-success';
            resultDiv.querySelector('strong').innerHTML = '<i class="bi bi-check-circle"></i> åœ°å€éªŒè¯æˆåŠŸ';
            resultDiv.style.display = 'block';

            showNotification('åœ°å€éªŒè¯æˆåŠŸ', 'success');
        } else {
            // æ˜¾ç¤ºéªŒè¯å¤±è´¥
            resultDiv.querySelector('.alert').className = 'alert alert-error';
            resultDiv.querySelector('.alert').innerHTML =
                `<strong><i class="bi bi-x-circle"></i> åœ°å€éªŒè¯å¤±è´¥</strong><br>${data.error}`;
            resultDiv.style.display = 'block';
        }
    } catch (error) {
        // Error already handled by apiRequest
        resultDiv.style.display = 'none';
    }
}

// é˜²æŠ–æœç´¢
const searchSpecies = debounce(async function(query) {
    if (!query || query.length < 2) {
        document.getElementById('searchResults').style.display = 'none';
        return;
    }

    try {
        const data = await apiRequest('/api/search_species', {
            method: 'POST',
            body: JSON.stringify({ query: query })
        });

        if (data.results && data.results.length > 0) {
            displaySearchResults(data.results);
        } else {
            document.getElementById('searchResults').innerHTML =
                '<div style="padding: 1rem; text-align: center; color: #999;">æœªæ‰¾åˆ°ç›¸å…³ç‰©ç§</div>';
            document.getElementById('searchResults').style.display = 'block';
        }
    } catch (error) {
        // Error already handled
    }
}, 300);

function displaySearchResults(results) {
    const container = document.getElementById('searchResults');
    container.innerHTML = results.map((bird, index) => {
        // Store bird data using data-index to avoid quote escaping issues
        const birdJson = JSON.stringify(bird).replace(/'/g, '&apos;');
        return `
            <div class="search-result-item" data-bird='${birdJson}' onclick='selectSpeciesFromElement(this)'>
                <div class="cn-name">${bird.cn_name || bird.chinese_simplified || 'æœªçŸ¥'}</div>
                <div class="en-name">${bird.en_name || bird.english_name || 'Unknown'}</div>
                <div class="code">${bird.code || bird.ebird_code}</div>
            </div>
        `;
    }).join('');
    container.style.display = 'block';
}

function selectSpeciesFromElement(element) {
    const birdJson = element.getAttribute('data-bird');
    const bird = JSON.parse(birdJson);
    selectSpecies(bird);
}

function selectSpecies(bird) {
    const code = bird.code || bird.ebird_code;

    // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©
    if (selectedSpeciesList.find(s => s.code === code)) {
        showNotification('è¯¥ç‰©ç§å·²åœ¨åˆ—è¡¨ä¸­', 'warning');
        return;
    }

    // å•ç‰©ç§æ¨¡å¼åªå…è®¸ä¸€ä¸ª
    if (selectedMode === 'single') {
        selectedSpeciesList = [];
    }

    selectedSpeciesList.push({
        code: code,
        cn_name: bird.cn_name || bird.chinese_simplified,
        en_name: bird.en_name || bird.english_name
    });

    updateSelectedDisplay();
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('speciesSearch').value = '';
}

function updateSelectedDisplay() {
    const container = document.getElementById('selectedSpecies');
    const list = document.getElementById('selectedList');

    if (selectedSpeciesList.length === 0) {
        container.style.display = 'none';
        document.getElementById('trackBtn').disabled = true;
        return;
    }

    container.style.display = 'block';
    document.getElementById('trackBtn').disabled = false;

    list.innerHTML = selectedSpeciesList.map((species, index) => `
        <div class="selected-tag">
            <span>${species.cn_name} (${species.code})</span>
            <button onclick="removeSpecies(${index})">Ã—</button>
        </div>
    `).join('');
}

function removeSpecies(index) {
    selectedSpeciesList.splice(index, 1);
    updateSelectedDisplay();
}

function clearSelection() {
    selectedSpeciesList = [];
    updateSelectedDisplay();
    document.getElementById('speciesSearch').value = '';
}

async function startTracking() {
    if (selectedSpeciesList.length === 0) {
        showNotification('è¯·å…ˆé€‰æ‹©è¦è¿½è¸ªçš„ç‰©ç§', 'warning');
        return;
    }

    const searchMode = document.getElementById('searchMode').value;
    const analysisMode = document.getElementById('analysisMode').value;

    const params = {
        species_codes: selectedSpeciesList.map(s => s.code),
        species_names: selectedSpeciesList,
        analysis_mode: analysisMode  // æ·»åŠ åˆ†ææ¨¡å¼å‚æ•°
    };

    // æ ¹æ®æœç´¢æ¨¡å¼å‡†å¤‡å‚æ•°
    if (searchMode === 'region') {
        // åŒºåŸŸæ¨¡å¼
        const countryCode = document.getElementById('countrySelect').value;
        const regionCode = document.getElementById('regionCode').value;

        if (!countryCode) {
            showNotification('è¯·å…ˆé€‰æ‹©å›½å®¶', 'warning');
            trackBtn.disabled = false;
            trackBtn.innerHTML = '<i class="bi bi-play-circle-fill"></i> å¼€å§‹è¿½è¸ª';
            return;
        }

        params.search_mode = 'region';
        params.region_code = regionCode || countryCode;  // å¦‚æœæ²¡é€‰åŒºåŸŸï¼Œä½¿ç”¨å›½å®¶ä»£ç 
        params.days_back = parseInt(document.getElementById('daysBack').value);
    } else {
        // GPSæ¨¡å¼
        const gpsLocation = document.getElementById('gpsLocation').value.trim();
        if (!gpsLocation) {
            showNotification('è¯·è¾“å…¥GPSåæ ‡æˆ–åœ°ç‚¹åç§°', 'warning');
            return;
        }

        params.search_mode = 'gps';

        // å¦‚æœå·²ç»éªŒè¯äº†åœ°å€,ä½¿ç”¨éªŒè¯åçš„åæ ‡;å¦åˆ™ç›´æ¥ä½¿ç”¨è¾“å…¥æ¡†çš„å€¼
        if (verifiedCoordinates) {
            params.gps_location = `${verifiedCoordinates.latitude}, ${verifiedCoordinates.longitude}`;
        } else {
            params.gps_location = gpsLocation;
        }

        params.radius = parseInt(document.getElementById('radius').value);
        params.days_back = parseInt(document.getElementById('daysBackGPS').value);
    }

    // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
    const trackBtn = document.getElementById('trackBtn');
    trackBtn.disabled = true;
    trackBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> æŸ¥è¯¢ä¸­...';

    // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
    const speciesCount = selectedSpeciesList.length;
    const speciesNames = selectedSpeciesList.map(s => s.cn_name).join('ã€');
    showLoading(
        `æ­£åœ¨è¿½è¸ª ${speciesCount} ä¸ªç‰©ç§...`,
        `æ­£åœ¨æŸ¥è¯¢ ${speciesNames} çš„è§‚æµ‹è®°å½•ï¼Œè¯·ç¨å€™...`
    );

    try {
        const data = await apiRequest('/api/track', {
            method: 'POST',
            body: JSON.stringify(params)
        });

        if (data.success) {
            // æ˜¾ç¤ºç»“æœæ‘˜è¦
            const message = `æŸ¥è¯¢å®Œæˆï¼æ‰¾åˆ° ${data.observations_count} æ¡è§‚æµ‹è®°å½•ï¼Œ` +
                          `æ¶‰åŠ ${data.unique_locations} ä¸ªåœ°ç‚¹`;
            showNotification(message, 'success');

            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            const resultsArea = document.getElementById('resultsArea');
            const resultsContent = document.getElementById('resultsContent');

            resultsContent.innerHTML = `
                <div class="result-summary">
                    <div class="summary-card">
                        <div class="summary-icon"><i class="bi bi-check-circle-fill"></i></div>
                        <div class="summary-content">
                            <h3>æŸ¥è¯¢æˆåŠŸ</h3>
                            <div class="summary-stats">
                                <div class="stat-item">
                                    <span class="stat-label">è§‚æµ‹è®°å½•</span>
                                    <span class="stat-value">${data.observations_count}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">è§‚æµ‹åœ°ç‚¹</span>
                                    <span class="stat-value">${data.unique_locations}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">ç‰©ç§æ•°é‡</span>
                                    <span class="stat-value">${data.species_count}</span>
                                </div>
                            </div>
                            <p class="summary-note">
                                <i class="bi bi-check-circle-fill"></i>
                                <strong>æŠ¥å‘Šå·²ç”Ÿæˆï¼š</strong> ${data.report_file}
                            </p>
                            <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center;">
                                <a href="/reports" class="btn btn-primary">
                                    <i class="bi bi-folder-fill"></i> æŸ¥çœ‹æ‰€æœ‰æŠ¥å‘Š
                                </a>
                                <button onclick="viewReport('${data.report_path}')" class="btn btn-secondary">
                                    <i class="bi bi-eye-fill"></i> é¢„è§ˆæŠ¥å‘Š
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            resultsArea.style.display = 'block';

            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            resultsArea.scrollIntoView({ behavior: 'smooth' });

        } else {
            showNotification(data.message || 'æœªæ‰¾åˆ°è§‚æµ‹è®°å½•', 'warning');
        }
    } catch (error) {
        // Error already handled
    } finally {
        // éšè—åŠ è½½åŠ¨ç”»
        hideLoading();

        // æ¢å¤æŒ‰é’®
        trackBtn.disabled = false;
        trackBtn.innerHTML = '<i class="bi bi-play-circle-fill"></i> å¼€å§‹è¿½è¸ª';
    }
}


// æŸ¥çœ‹æŠ¥å‘Šï¼ˆè·³è½¬åˆ°ç»“æœé¡µé¢ï¼‰
function viewReport(reportPath) {
    // è·³è½¬åˆ°ç»“æœé¡µé¢è¿›è¡Œåœ¨çº¿é¢„è§ˆ
    window.location.href = `/result/${reportPath}`;
}

// åŠ è½½æ‰€æœ‰å›½å®¶åˆ—è¡¨
async function loadCountries() {
    try {
        const data = await apiRequest('/api/ebird/countries');

        if (data.success && data.countries) {
            const select = document.getElementById('countrySelect');
            const topCount = data.top_endemic_count || 20;

            data.countries.forEach((country, index) => {
                const displayName = country.name_zh || country.name_en;
                const option = document.createElement('option');
                option.value = country.code;

                // å‰20åæ˜¾ç¤ºç‰¹æœ‰ç§æ•°é‡å’Œç‰¹æ®Šæ ‡è®°
                if (index < topCount && country.endemic_count > 0) {
                    option.textContent = `ğŸŒŸ ${displayName} (${country.code}) - ${country.endemic_count}ç§ç‰¹æœ‰é¸Ÿ`;
                    option.style.fontWeight = 'bold';
                } else {
                    option.textContent = `${displayName} (${country.code})`;
                }

                select.appendChild(option);

                // åœ¨ç¬¬20ä¸ªä¹‹åæ·»åŠ åˆ†éš”çº¿
                if (index === topCount - 1) {
                    const separator = document.createElement('option');
                    separator.disabled = true;
                    separator.textContent = 'â”€â”€â”€â”€â”€â”€â”€ å…¶ä»–å›½å®¶ï¼ˆæŒ‰å­—æ¯æ’åºï¼‰ â”€â”€â”€â”€â”€â”€â”€';
                    separator.style.textAlign = 'center';
                    separator.style.fontStyle = 'italic';
                    separator.style.color = '#999';
                    select.appendChild(separator);
                }
            });

            console.log(`å·²åŠ è½½ ${data.countries.length} ä¸ªå›½å®¶ï¼ˆå‰${topCount}åæŒ‰ç‰¹æœ‰ç§æ’åºï¼‰`);
        }
    } catch (error) {
        console.error('åŠ è½½å›½å®¶åˆ—è¡¨å¤±è´¥:', error);
    }
}

// æ ¹æ®é€‰ä¸­çš„å›½å®¶åŠ è½½åŒºåŸŸåˆ—è¡¨
async function loadRegions() {
    const countryCode = document.getElementById('countrySelect').value;
    const regionSelectGroup = document.getElementById('regionSelectGroup');
    const regionSelect = document.getElementById('regionCode');

    if (!countryCode) {
        regionSelectGroup.style.display = 'none';
        regionSelect.innerHTML = '<option value="">-- è¯·å…ˆé€‰æ‹©å›½å®¶ --</option>';
        return;
    }

    try {
        const data = await apiRequest(`/api/ebird/regions/${countryCode}`);

        if (data.success) {
            regionSelect.innerHTML = '';

            // æ·»åŠ "å…¨å¢ƒ"é€‰é¡¹
            const wholeCountryOption = document.createElement('option');
            wholeCountryOption.value = countryCode;
            wholeCountryOption.textContent = 'è¯¥å›½å…¨å¢ƒ';
            regionSelect.appendChild(wholeCountryOption);

            // æ·»åŠ å„åŒºåŸŸ
            if (data.regions && data.regions.length > 0) {
                data.regions.forEach(region => {
                    const displayName = region.name_zh || region.name_en;
                    const option = document.createElement('option');
                    option.value = region.code;
                    option.textContent = displayName;
                    regionSelect.appendChild(option);
                });

                regionSelectGroup.style.display = 'block';
                console.log(`å·²åŠ è½½ ${data.regions.length} ä¸ªåŒºåŸŸ`);
            } else {
                // å¦‚æœæ²¡æœ‰åŒºåŸŸï¼Œåªæ˜¾ç¤ºå…¨å¢ƒé€‰é¡¹
                regionSelectGroup.style.display = 'block';
            }
        }
    } catch (error) {
        console.error('åŠ è½½åŒºåŸŸåˆ—è¡¨å¤±è´¥:', error);
        regionSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</option>';
    }
}
</script>
{% endblock %}
