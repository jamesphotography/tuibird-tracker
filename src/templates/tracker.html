{% extends "base.html" %}

{% block title %}物种追踪 - 图忆鸟讯{% endblock %}

{% block content %}
<div class="tracker-container">
    <h1 class="page-title">
        <i class="bi bi-bullseye"></i> 物种追踪
    </h1>

    <div class="tracker-card">
        <div class="mode-selector">
            <h2>选择追踪模式</h2>
            <div class="mode-buttons">
                <button onclick="selectMode('single')" class="mode-btn active" id="singleModeBtn">
                    <i class="bi bi-search"></i>
                    <div>单物种追踪</div>
                    <small>深度追踪单个鸟种</small>
                </button>
                <button onclick="selectMode('multi')" class="mode-btn" id="multiModeBtn">
                    <i class="bi bi-collection-fill"></i>
                    <div>多物种分析</div>
                    <small>同时追踪多个鸟种</small>
                </button>
            </div>
        </div>

        <!-- 物种搜索 -->
        <div class="form-group">
            <label class="form-label">
                <i class="bi bi-search"></i> 搜索鸟种
                <span class="text-muted">（支持中英文）</span>
            </label>
            <input type="text"
                   id="speciesSearch"
                   class="form-control"
                   placeholder="输入鸟种名称，如：七彩文鸟、Gouldian Finch"
                   oninput="searchSpecies(this.value)">
        </div>

        <!-- 搜索结果 -->
        <div id="searchResults" class="search-results" style="display: none;"></div>

        <!-- 已选择的物种 -->
        <div id="selectedSpecies" class="selected-species" style="display: none;">
            <h3>已选择的物种</h3>
            <div id="selectedList" class="selected-list"></div>
        </div>

        <!-- 查询参数 -->
        <div class="query-params">
            <h3>查询参数</h3>

            <div class="form-group">
                <label class="form-label">
                    <i class="bi bi-diagram-3"></i> 多物种分析模式
                    <small class="text-muted">(仅在选择多个物种时生效)</small>
                </label>
                <select id="analysisMode" class="form-control">
                    <option value="and" selected>同时出现 - 查找多个物种在同一地点共同出现的记录 (推荐，速度快)</option>
                    <option value="or">任一物种 - 分别查询每个物种的所有观测记录</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">搜索模式</label>
                <select id="searchMode" class="form-control" onchange="toggleSearchMode()">
                    <option value="gps" selected>GPS搜索 - 按地点名称或坐标查询</option>
                    <option value="region">区域搜索 - 按行政区域查询</option>
                </select>
            </div>

            <!-- GPS搜索参数（默认显示） -->
            <div id="gpsModeParams">
                <div class="form-group">
                    <label class="form-label">GPS 坐标或地点名称</label>
                    <div class="input-with-button">
                        <input type="text"
                               id="gpsLocation"
                               class="form-control"
                               placeholder="例如: Darwin Waterfront 或 Kakadu National Park">
                        <button type="button" onclick="verifyLocation()" class="btn btn-secondary btn-sm">
                            <i class="bi bi-search"></i> 验证地址
                        </button>
                    </div>
                    <small class="text-muted">
                        <i class="bi bi-lightbulb"></i>
                        <strong>地点示例：</strong>城市名(Darwin)、地标(Sydney Opera House)、国家公园(Kakadu National Park)、邮编区域(Darwin NT 0800)、或GPS坐标(-12.4634, 130.8456)
                    </small>

                    <!-- 验证结果显示 -->
                    <div id="locationVerifyResult" style="display: none; margin-top: 0.75rem;">
                        <div class="alert alert-success">
                            <strong><i class="bi bi-check-circle"></i> 地址验证成功</strong><br>
                            <span id="verifiedAddress"></span><br>
                            <small>GPS坐标: <span id="verifiedCoords"></span></small>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="bi bi-circle"></i> 搜索半径 (km)
                        </label>
                        <input type="range"
                               id="radius"
                               class="form-range"
                               min="1"
                               max="50"
                               value="25"
                               oninput="updateRadiusDisplay(this.value)">
                        <div class="range-display">
                            <span id="radiusDisplay">25</span> km
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">时间范围</label>
                        <select id="daysBackGPS" class="form-control">
                            <option value="7">最近 7 天</option>
                            <option value="14" selected>最近 14 天</option>
                            <option value="30">最近 30 天</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 区域搜索参数 -->
            <div id="regionModeParams" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">选择区域</label>
                        <select id="regionCode" class="form-control">
                            <option value="AU">澳大利亚全境</option>
                            <option value="AU-NT">北领地 (NT)</option>
                            <option value="AU-NSW">新南威尔士 (NSW)</option>
                            <option value="AU-QLD">昆士兰 (QLD)</option>
                            <option value="AU-WA">西澳大利亚 (WA)</option>
                            <option value="AU-SA">南澳大利亚 (SA)</option>
                            <option value="AU-VIC">维多利亚 (VIC)</option>
                            <option value="AU-ACT">首都领地 (ACT)</option>
                            <option value="AU-TAS">塔斯马尼亚 (TAS)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">时间范围</label>
                        <select id="daysBack" class="form-control">
                            <option value="7">最近 7 天</option>
                            <option value="14" selected>最近 14 天</option>
                            <option value="30">最近 30 天</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="action-buttons">
            <button onclick="startTracking()" class="btn btn-primary btn-lg" id="trackBtn" disabled>
                <i class="bi bi-play-circle-fill"></i> 开始追踪
            </button>
            <button onclick="clearSelection()" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> 清空选择
            </button>
        </div>
    </div>

    <!-- 结果显示区域 -->
    <div id="resultsArea" style="display: none;">
        <h2>追踪结果</h2>
        <div id="resultsContent"></div>
    </div>
</div>

<style>
.tracker-container {
    width: 100%;
    max-width: 100%;
    margin: 0;
    padding: 0 1rem;
}

.page-title {
    font-size: 2.5rem;
    margin-bottom: 2rem;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 1rem;
}

.tracker-card {
    background: var(--card-bg);
    padding: 2rem;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
}

.mode-selector {
    margin-bottom: 2rem;
}

.mode-selector h2 {
    font-size: 1.3rem;
    margin-bottom: 1rem;
    color: var(--primary-color);
}

.mode-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.mode-btn {
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
}

.mode-btn i {
    font-size: 2rem;
    display: block;
    margin-bottom: 0.5rem;
    color: var(--secondary-color);
}

.mode-btn div {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.mode-btn small {
    color: var(--text-light);
    font-size: 0.85rem;
}

.mode-btn:hover {
    border-color: var(--secondary-color);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.mode-btn.active {
    border-color: var(--primary-color);
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
}

.search-results {
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    max-height: 300px;
    overflow-y: auto;
    margin-top: 0.5rem;
}

.search-result-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
    transition: var(--transition);
}

.search-result-item:last-child {
    border-bottom: none;
}

.search-result-item:hover {
    background: #f8f9fa;
}

.search-result-item .cn-name {
    font-weight: 600;
    color: var(--text-dark);
}

.search-result-item .en-name {
    color: var(--text-light);
    font-size: 0.9rem;
}

.search-result-item .code {
    font-size: 0.85rem;
    color: var(--text-light);
    font-family: monospace;
}

.selected-species {
    margin: 1.5rem 0;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.selected-species h3 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
    color: var(--primary-color);
}

.selected-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.selected-tag {
    background: var(--primary-color);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.selected-tag button {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 0;
    font-size: 1.2rem;
    line-height: 1;
}

.query-params {
    margin: 2rem 0;
}

.query-params h3 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
    color: var(--primary-color);
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.action-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
}

/* 结果摘要样式 */
.result-summary {
    margin-top: 3rem;
}

.summary-card {
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    padding: 2rem;
    border-radius: 12px;
    border: 2px solid var(--success-color);
    display: flex;
    gap: 1.5rem;
    align-items: flex-start;
}

.summary-icon {
    font-size: 3rem;
    color: var(--success-color);
}

.summary-content {
    flex: 1;
}

.summary-content h3 {
    color: var(--success-color);
    margin-bottom: 1rem;
}

.summary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.stat-item {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
}

.stat-label {
    display: block;
    font-size: 0.85rem;
    color: var(--text-light);
    margin-bottom: 0.5rem;
}

.stat-value {
    display: block;
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary-color);
}

.summary-note {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
}

.range-display {
    text-align: center;
    margin-top: 0.5rem;
    font-weight: 600;
    color: var(--primary-color);
}

.form-range {
    width: 100%;
}

.input-with-button {
    display: flex;
    gap: 0.5rem;
}

.input-with-button .form-control {
    flex: 1;
}

.alert {
    padding: 0.75rem 1rem;
    border-radius: 8px;
    border: 1px solid;
}

.alert-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.alert-error {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let selectedMode = 'single';
let selectedSpeciesList = [];

function selectMode(mode) {
    selectedMode = mode;

    // 更新按钮状态
    document.getElementById('singleModeBtn').classList.toggle('active', mode === 'single');
    document.getElementById('multiModeBtn').classList.toggle('active', mode === 'multi');

    // 单物种模式下自动清空多选
    if (mode === 'single' && selectedSpeciesList.length > 1) {
        selectedSpeciesList = [];
        updateSelectedDisplay();
    }
}

// 切换搜索模式
function toggleSearchMode() {
    const searchMode = document.getElementById('searchMode').value;
    const regionParams = document.getElementById('regionModeParams');
    const gpsParams = document.getElementById('gpsModeParams');

    if (searchMode === 'region') {
        regionParams.style.display = 'block';
        gpsParams.style.display = 'none';
    } else {
        regionParams.style.display = 'none';
        gpsParams.style.display = 'block';
    }
}

// 更新半径显示
function updateRadiusDisplay(value) {
    document.getElementById('radiusDisplay').textContent = value;
}

// 验证地址
async function verifyLocation() {
    const gpsLocation = document.getElementById('gpsLocation').value.trim();
    const resultDiv = document.getElementById('locationVerifyResult');

    if (!gpsLocation) {
        showNotification('请输入地点名称或GPS坐标', 'warning');
        return;
    }

    try {
        showNotification('正在验证地址...', 'info');

        const data = await apiRequest('/api/geocode', {
            method: 'POST',
            body: JSON.stringify({ place_name: gpsLocation })
        });

        if (data.success) {
            // 显示验证成功结果
            document.getElementById('verifiedAddress').textContent = data.display_name;
            document.getElementById('verifiedCoords').textContent =
                `${data.latitude.toFixed(4)}, ${data.longitude.toFixed(4)}`;

            resultDiv.querySelector('.alert').className = 'alert alert-success';
            resultDiv.querySelector('strong').innerHTML = '<i class="bi bi-check-circle"></i> 地址验证成功';
            resultDiv.style.display = 'block';

            showNotification('地址验证成功', 'success');
        } else {
            // 显示验证失败
            resultDiv.querySelector('.alert').className = 'alert alert-error';
            resultDiv.querySelector('.alert').innerHTML =
                `<strong><i class="bi bi-x-circle"></i> 地址验证失败</strong><br>${data.error}`;
            resultDiv.style.display = 'block';
        }
    } catch (error) {
        // Error already handled by apiRequest
        resultDiv.style.display = 'none';
    }
}

// 防抖搜索
const searchSpecies = debounce(async function(query) {
    if (!query || query.length < 2) {
        document.getElementById('searchResults').style.display = 'none';
        return;
    }

    try {
        const data = await apiRequest('/api/search_species', {
            method: 'POST',
            body: JSON.stringify({ query: query })
        });

        if (data.results && data.results.length > 0) {
            displaySearchResults(data.results);
        } else {
            document.getElementById('searchResults').innerHTML =
                '<div style="padding: 1rem; text-align: center; color: #999;">未找到相关物种</div>';
            document.getElementById('searchResults').style.display = 'block';
        }
    } catch (error) {
        // Error already handled
    }
}, 300);

function displaySearchResults(results) {
    const container = document.getElementById('searchResults');
    container.innerHTML = results.map(bird => `
        <div class="search-result-item" onclick='selectSpecies(${JSON.stringify(bird)})'>
            <div class="cn-name">${bird.cn_name || bird.chinese_simplified || '未知'}</div>
            <div class="en-name">${bird.en_name || bird.english_name || 'Unknown'}</div>
            <div class="code">${bird.code || bird.ebird_code}</div>
        </div>
    `).join('');
    container.style.display = 'block';
}

function selectSpecies(bird) {
    const code = bird.code || bird.ebird_code;

    // 检查是否已选择
    if (selectedSpeciesList.find(s => s.code === code)) {
        showNotification('该物种已在列表中', 'warning');
        return;
    }

    // 单物种模式只允许一个
    if (selectedMode === 'single') {
        selectedSpeciesList = [];
    }

    selectedSpeciesList.push({
        code: code,
        cn_name: bird.cn_name || bird.chinese_simplified,
        en_name: bird.en_name || bird.english_name
    });

    updateSelectedDisplay();
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('speciesSearch').value = '';
}

function updateSelectedDisplay() {
    const container = document.getElementById('selectedSpecies');
    const list = document.getElementById('selectedList');

    if (selectedSpeciesList.length === 0) {
        container.style.display = 'none';
        document.getElementById('trackBtn').disabled = true;
        return;
    }

    container.style.display = 'block';
    document.getElementById('trackBtn').disabled = false;

    list.innerHTML = selectedSpeciesList.map((species, index) => `
        <div class="selected-tag">
            <span>${species.cn_name} (${species.code})</span>
            <button onclick="removeSpecies(${index})">×</button>
        </div>
    `).join('');
}

function removeSpecies(index) {
    selectedSpeciesList.splice(index, 1);
    updateSelectedDisplay();
}

function clearSelection() {
    selectedSpeciesList = [];
    updateSelectedDisplay();
    document.getElementById('speciesSearch').value = '';
}

async function startTracking() {
    if (selectedSpeciesList.length === 0) {
        showNotification('请先选择要追踪的物种', 'warning');
        return;
    }

    const searchMode = document.getElementById('searchMode').value;
    const analysisMode = document.getElementById('analysisMode').value;

    const params = {
        species_codes: selectedSpeciesList.map(s => s.code),
        species_names: selectedSpeciesList,
        analysis_mode: analysisMode  // 添加分析模式参数
    };

    // 根据搜索模式准备参数
    if (searchMode === 'region') {
        // 区域模式
        params.search_mode = 'region';
        params.region_code = document.getElementById('regionCode').value;
        params.days_back = parseInt(document.getElementById('daysBack').value);
    } else {
        // GPS模式
        const gpsLocation = document.getElementById('gpsLocation').value.trim();
        if (!gpsLocation) {
            showNotification('请输入GPS坐标或地点名称', 'warning');
            return;
        }

        params.search_mode = 'gps';
        params.gps_location = gpsLocation;
        params.radius = parseInt(document.getElementById('radius').value);
        params.days_back = parseInt(document.getElementById('daysBackGPS').value);
    }

    // 禁用按钮，防止重复提交
    const trackBtn = document.getElementById('trackBtn');
    trackBtn.disabled = true;
    trackBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 查询中...';

    try {
        showNotification('正在查询 eBird 数据，请稍候...', 'info');

        const data = await apiRequest('/api/track', {
            method: 'POST',
            body: JSON.stringify(params)
        });

        if (data.success) {
            // 显示结果摘要
            const message = `查询完成！找到 ${data.observations_count} 条观测记录，` +
                          `涉及 ${data.unique_locations} 个地点`;
            showNotification(message, 'success');

            // 显示结果区域
            const resultsArea = document.getElementById('resultsArea');
            const resultsContent = document.getElementById('resultsContent');

            resultsContent.innerHTML = `
                <div class="result-summary">
                    <div class="summary-card">
                        <div class="summary-icon"><i class="bi bi-check-circle-fill"></i></div>
                        <div class="summary-content">
                            <h3>查询成功</h3>
                            <div class="summary-stats">
                                <div class="stat-item">
                                    <span class="stat-label">观测记录</span>
                                    <span class="stat-value">${data.observations_count}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">观测地点</span>
                                    <span class="stat-value">${data.unique_locations}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">物种数量</span>
                                    <span class="stat-value">${data.species_count}</span>
                                </div>
                            </div>
                            <p class="summary-note">
                                <i class="bi bi-check-circle-fill"></i>
                                <strong>报告已生成：</strong> ${data.report_file}
                            </p>
                            <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center;">
                                <a href="/reports" class="btn btn-primary">
                                    <i class="bi bi-folder-fill"></i> 查看所有报告
                                </a>
                                <button onclick="viewReport('${data.report_path}')" class="btn btn-secondary">
                                    <i class="bi bi-eye-fill"></i> 预览报告
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            resultsArea.style.display = 'block';

            // 滚动到结果区域
            resultsArea.scrollIntoView({ behavior: 'smooth' });

        } else {
            showNotification(data.message || '未找到观测记录', 'warning');
        }
    } catch (error) {
        // Error already handled
    } finally {
        // 恢复按钮
        trackBtn.disabled = false;
        trackBtn.innerHTML = '<i class="bi bi-play-circle-fill"></i> 开始追踪';
    }
}


// 查看报告（跳转到结果页面）
function viewReport(reportPath) {
    // 跳转到结果页面进行在线预览
    window.location.href = `/result/${reportPath}`;
}
</script>
{% endblock %}
