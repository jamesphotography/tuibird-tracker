{% extends "base.html" %}

{% block title %}åŒºåŸŸæŸ¥è¯¢ - æ…§çœ¼æ‰¾é¸Ÿ{% endblock %}

{% block content %}
<div class="region-container">
    <h1 class="page-title">
        <i class="bi bi-globe-americas"></i> åŒºåŸŸæŸ¥è¯¢
    </h1>

    <div class="region-card">
        <p class="intro-text">
            <i class="bi bi-info-circle"></i>
            æ ¹æ® GPS åæ ‡æˆ–åœ°ç‚¹åç§°ï¼ŒæŸ¥è¯¢è¯¥åŒºåŸŸå†…æ‰€æœ‰é¸Ÿç§çš„æœ€è¿‘è§‚æµ‹è®°å½•
        </p>

        <!-- ä½ç½®è¾“å…¥ -->
        <div class="location-input">
            <h3>è¾“å…¥ä½ç½®</h3>

            <div class="input-method-tabs">
                <button onclick="switchInputMethod('place')"
                        class="tab-btn active"
                        id="placeTab">
                    <i class="bi bi-pin-map-fill"></i> åœ°ç‚¹åç§°
                </button>
                <button onclick="switchInputMethod('coords')"
                        class="tab-btn"
                        id="coordsTab">
                    <i class="bi bi-geo-alt-fill"></i> GPS åæ ‡
                </button>
                <button onclick="switchInputMethod('admin')"
                        class="tab-btn"
                        id="adminTab">
                    <i class="bi bi-map-fill"></i> è¡Œæ”¿åŒºåŸŸ
                </button>
            </div>

            <!-- åœ°ç‚¹åç§°è¾“å…¥ -->
            <div id="placeInput" class="input-panel">
                <div class="form-group">
                    <label class="form-label">åœ°ç‚¹åç§°</label>
                    <div class="input-with-button">
                        <input type="text"
                               id="placeName"
                               class="form-control"
                               placeholder="ä¾‹å¦‚: Darwin Waterfront, Kakadu National Park">
                        <button type="button" onclick="verifyPlaceName()" class="btn btn-secondary btn-sm">
                            <i class="bi bi-search"></i> éªŒè¯åœ°å€
                        </button>
                    </div>
                    <small class="text-muted">
                        <i class="bi bi-lightbulb"></i>
                        <strong>ç¤ºä¾‹ï¼š</strong>åŸå¸‚(Darwin)ã€åœ°æ ‡(Sydney Opera House)ã€å›½å®¶å…¬å›­(Kakadu National Park)ã€é‚®ç¼–åŒºåŸŸ(Darwin NT 0800)
                    </small>

                    <!-- éªŒè¯ç»“æœæ˜¾ç¤º -->
                    <div id="placeVerifyResult" style="display: none; margin-top: 0.75rem;">
                        <div class="alert alert-success">
                            <strong><i class="bi bi-check-circle"></i> åœ°å€éªŒè¯æˆåŠŸ</strong><br>
                            <span id="verifiedPlaceAddress"></span><br>
                            <small>GPSåæ ‡: <span id="verifiedPlaceCoords"></span></small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GPS åæ ‡è¾“å…¥ -->
            <div id="coordsInput" class="input-panel" style="display: none;">
                <div class="form-group">
                    <label class="form-label">GPS åæ ‡</label>
                    <input type="text"
                           id="coordsString"
                           class="form-control"
                           placeholder="ä¾‹å¦‚: -12.4634, 130.8456 æˆ– -12.4634 130.8456"
                           oninput="parseCoordinates(this.value)">
                    <small class="text-muted">
                        <i class="bi bi-lightbulb"></i>
                        å¯ä»¥ç›´æ¥ä» Google Maps å¤åˆ¶ç²˜è´´åæ ‡ï¼ˆæ”¯æŒé€—å·æˆ–ç©ºæ ¼åˆ†éš”ï¼‰
                    </small>
                </div>

                <!-- éšè—çš„åˆ†ç¦»å­—æ®µï¼Œç”¨äºå­˜å‚¨è§£æåçš„å€¼ -->
                <input type="hidden" id="latitude">
                <input type="hidden" id="longitude">

                <!-- æ˜¾ç¤ºè§£æç»“æœ -->
                <div id="parsedCoords" class="parsed-coords" style="display: none;">
                    <div class="coords-display">
                        <span class="coords-label">çº¬åº¦:</span>
                        <span id="displayLat" class="coords-value">--</span>
                        <span class="coords-label">ç»åº¦:</span>
                        <span id="displayLng" class="coords-value">--</span>
                    </div>
                </div>
            </div>

            <!-- è¡Œæ”¿åŒºåŸŸè¾“å…¥ -->
            <div id="adminInput" class="input-panel" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="bi bi-globe"></i> é€‰æ‹©å›½å®¶
                        </label>
                        <select id="adminCountrySelect" class="form-control" onchange="loadAdminRegions()">
                            <option value="">-- è¯·é€‰æ‹©å›½å®¶ --</option>
                        </select>
                        <small class="text-muted">
                            <i class="bi bi-lightbulb"></i> æ”¯æŒ 253 ä¸ªå›½å®¶å’Œåœ°åŒº
                        </small>
                    </div>
                </div>

                <div class="form-group" id="adminRegionSelectGroup" style="display: none;">
                    <label class="form-label">
                        <i class="bi bi-map"></i> é€‰æ‹©åŒºåŸŸ
                        <small class="text-muted">(å¯é€‰ï¼Œä¸é€‰åˆ™æŸ¥è¯¢æ•´ä¸ªå›½å®¶çš„ä¸­å¿ƒç‚¹é™„è¿‘)</small>
                    </label>
                    <select id="adminRegionSelect" class="form-control">
                        <option value="">-- è¯·å…ˆé€‰æ‹©å›½å®¶ --</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- æŸ¥è¯¢å‚æ•° -->
        <div class="query-params">
            <h3>æŸ¥è¯¢å‚æ•°</h3>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">
                        <i class="bi bi-circle"></i> æœç´¢åŠå¾„ (km)
                    </label>
                    <input type="range"
                           id="radius"
                           class="form-range"
                           min="1"
                           max="50"
                           value="25"
                           oninput="updateRadiusDisplay(this.value)">
                    <div class="range-display">
                        <span id="radiusDisplay">25</span> km
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <i class="bi bi-calendar"></i> æ—¶é—´èŒƒå›´
                    </label>
                    <select id="daysBack" class="form-control">
                        <option value="7">æœ€è¿‘ 7 å¤©</option>
                        <option value="14" selected>æœ€è¿‘ 14 å¤©</option>
                        <option value="30">æœ€è¿‘ 30 å¤©</option>
                    </select>
                </div>
            </div>

        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="action-buttons">
            <button onclick="startQuery()" class="btn btn-primary btn-lg">
                <i class="bi bi-search"></i> å¼€å§‹æŸ¥è¯¢
            </button>
            <button onclick="resetForm()" class="btn btn-secondary">
                <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®
            </button>
        </div>
    </div>

    <!-- ç»“æœæ˜¾ç¤º -->
    <div id="resultsArea" style="display: none;">
        <h2>æŸ¥è¯¢ç»“æœ</h2>
        <div id="resultsContent"></div>
    </div>
</div>

<style>
.region-container {
    max-width: 900px;
    margin: 0 auto;
}

.page-title {
    font-size: 2.5rem;
    margin-bottom: 2rem;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 1rem;
}

.region-card {
    background: var(--card-bg);
    padding: 2rem;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
}

.intro-text {
    background: #e3f2fd;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    color: var(--text-dark);
}

.location-input,
.query-params {
    margin-bottom: 2rem;
}

.location-input h3,
.query-params h3 {
    font-size: 1.2rem;
    margin-bottom: 1rem;
    color: var(--primary-color);
}

.input-method-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
}

.tab-btn {
    flex: 1;
    padding: 1rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    background: white;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-weight: 500;
}

.tab-btn:hover {
    border-color: var(--secondary-color);
}

.tab-btn.active {
    border-color: var(--primary-color);
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    color: var(--primary-color);
}

.input-panel {
    animation: fadeIn 0.3s;
}

.form-range {
    width: 100%;
}

.range-display {
    text-align: center;
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--primary-color);
    margin-top: 0.5rem;
}

.action-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
}

.parsed-coords {
    margin-top: 1rem;
    padding: 1rem;
    background: #e8f5e9;
    border-radius: 8px;
    border-left: 4px solid var(--success-color);
}

.coords-display {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.coords-label {
    font-weight: 600;
    color: var(--text-dark);
}

.coords-value {
    font-family: 'Courier New', monospace;
    font-size: 1.1rem;
    color: var(--primary-color);
    background: white;
}

.input-with-button {
    display: flex;
    gap: 0.5rem;
}

.input-with-button .form-control {
    flex: 1;
}

.alert {
    padding: 0.75rem 1rem;
    border-radius: 8px;
    border: 1px solid;
}

.alert-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.alert-error {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentInputMethod = 'place';

function switchInputMethod(method) {
    currentInputMethod = method;

    // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
    document.getElementById('placeTab').classList.toggle('active', method === 'place');
    document.getElementById('coordsTab').classList.toggle('active', method === 'coords');
    document.getElementById('adminTab').classList.toggle('active', method === 'admin');

    // åˆ‡æ¢è¾“å…¥é¢æ¿
    document.getElementById('placeInput').style.display = method === 'place' ? 'block' : 'none';
    document.getElementById('coordsInput').style.display = method === 'coords' ? 'block' : 'none';
    document.getElementById('adminInput').style.display = method === 'admin' ? 'block' : 'none';
}

function parseCoordinates(input) {
    /**
     * è§£æå„ç§æ ¼å¼çš„åæ ‡å­—ç¬¦ä¸²
     * æ”¯æŒçš„æ ¼å¼:
     * - -12.4634, 130.8456
     * - -12.4634 130.8456
     * - (-12.4634, 130.8456)
     * - 39Â°54'25.2"N 116Â°24'26.6"E (Google Maps æ ¼å¼)
     */

    input = input.trim();

    if (!input) {
        document.getElementById('parsedCoords').style.display = 'none';
        document.getElementById('latitude').value = '';
        document.getElementById('longitude').value = '';
        return;
    }

    let lat = null;
    let lng = null;

    // ç§»é™¤æ‹¬å·
    input = input.replace(/[()]/g, '');

    // å°è¯•åŒ¹é…å„ç§æ ¼å¼

    // æ ¼å¼ 1: ç®€å•çš„é€—å·æˆ–ç©ºæ ¼åˆ†éš” (æœ€å¸¸è§)
    const simplePattern = /^(-?\d+\.?\d*)[,\s]+(-?\d+\.?\d*)$/;
    const simpleMatch = input.match(simplePattern);

    if (simpleMatch) {
        lat = parseFloat(simpleMatch[1]);
        lng = parseFloat(simpleMatch[2]);
    } else {
        // æ ¼å¼ 2: åº¦åˆ†ç§’æ ¼å¼ (39Â°54'25.2"N 116Â°24'26.6"E)
        const dmsPattern = /(\d+)Â°(\d+)'([\d.]+)"([NS])\s+(\d+)Â°(\d+)'([\d.]+)"([EW])/;
        const dmsMatch = input.match(dmsPattern);

        if (dmsMatch) {
            // è½¬æ¢åº¦åˆ†ç§’ä¸ºåè¿›åˆ¶
            const latDeg = parseInt(dmsMatch[1]);
            const latMin = parseInt(dmsMatch[2]);
            const latSec = parseFloat(dmsMatch[3]);
            const latDir = dmsMatch[4];

            const lngDeg = parseInt(dmsMatch[5]);
            const lngMin = parseInt(dmsMatch[6]);
            const lngSec = parseFloat(dmsMatch[7]);
            const lngDir = dmsMatch[8];

            lat = latDeg + latMin/60 + latSec/3600;
            lng = lngDeg + lngMin/60 + lngSec/3600;

            if (latDir === 'S') lat = -lat;
            if (lngDir === 'W') lng = -lng;
        }
    }

    // éªŒè¯èŒƒå›´
    if (lat !== null && lng !== null) {
        if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
            // ä¿ç•™6ä½å°æ•°
            lat = Math.round(lat * 1000000) / 1000000;
            lng = Math.round(lng * 1000000) / 1000000;

            // æ›´æ–°éšè—å­—æ®µ
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;

            // æ˜¾ç¤ºè§£æç»“æœ
            document.getElementById('displayLat').textContent = lat;
            document.getElementById('displayLng').textContent = lng;
            document.getElementById('parsedCoords').style.display = 'block';
        } else {
            // åæ ‡è¶…å‡ºèŒƒå›´
            document.getElementById('parsedCoords').style.display = 'none';
            showNotification('åæ ‡è¶…å‡ºæœ‰æ•ˆèŒƒå›´', 'warning');
        }
    } else {
        // æ— æ³•è§£æ
        document.getElementById('parsedCoords').style.display = 'none';
    }
}

function updateRadiusDisplay(value) {
    document.getElementById('radiusDisplay').textContent = value;
}

async function startQuery() {
    let lat, lng;

    if (currentInputMethod === 'place') {
        const placeName = document.getElementById('placeName').value.trim();
        if (!placeName) {
            showNotification('è¯·è¾“å…¥åœ°ç‚¹åç§°', 'warning');
            return;
        }

        // ä½¿ç”¨ Geocoding API è½¬æ¢åœ°ç‚¹åç§°ä¸ºåæ ‡
        showNotification('æ­£åœ¨æŸ¥è¯¢åœ°ç‚¹åæ ‡...', 'info');

        try {
            const geocodeData = await apiRequest('/api/geocode', {
                method: 'POST',
                body: JSON.stringify({ place_name: placeName })
            });

            if (geocodeData.success) {
                lat = geocodeData.latitude;
                lng = geocodeData.longitude;
                showNotification(geocodeData.message, 'success');
            } else {
                showNotification(geocodeData.error || 'æ— æ³•æ‰¾åˆ°è¯¥åœ°ç‚¹', 'error');
                return;
            }
        } catch (error) {
            // Error already handled by apiRequest
            return;
        }

    } else if (currentInputMethod === 'admin') {
        // è¡Œæ”¿åŒºåŸŸæ¨¡å¼
        const countryCode = document.getElementById('adminCountrySelect').value;
        const regionCode = document.getElementById('adminRegionSelect').value;

        if (!countryCode) {
            showNotification('è¯·å…ˆé€‰æ‹©å›½å®¶', 'warning');
            return;
        }

        // æ„å»ºæŸ¥è¯¢åœ°ç‚¹åç§°ï¼ˆä½¿ç”¨åŒºåŸŸä»£ç æˆ–å›½å®¶ä»£ç ï¼‰
        const locationCode = regionCode || countryCode;

        // ä½¿ç”¨ Geocoding API è½¬æ¢è¡Œæ”¿åŒºåŸŸä¸ºåæ ‡
        showNotification('æ­£åœ¨æŸ¥è¯¢åŒºåŸŸåæ ‡...', 'info');

        try {
            const geocodeData = await apiRequest('/api/geocode', {
                method: 'POST',
                body: JSON.stringify({ place_name: locationCode })
            });

            if (geocodeData.success) {
                lat = geocodeData.latitude;
                lng = geocodeData.longitude;
                showNotification(`å·²å®šä½åˆ° ${geocodeData.display_name}`, 'success');
            } else {
                showNotification(geocodeData.error || 'æ— æ³•æ‰¾åˆ°è¯¥åŒºåŸŸ', 'error');
                return;
            }
        } catch (error) {
            // Error already handled by apiRequest
            return;
        }

    } else {
        // åæ ‡è¾“å…¥æ¨¡å¼
        lat = parseFloat(document.getElementById('latitude').value);
        lng = parseFloat(document.getElementById('longitude').value);

        if (!lat || !lng) {
            showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„ GPS åæ ‡', 'warning');
            return;
        }

        if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
            showNotification('GPS åæ ‡è¶…å‡ºæœ‰æ•ˆèŒƒå›´', 'error');
            return;
        }
    }

    const params = {
        lat: lat,
        lng: lng,
        radius: parseInt(document.getElementById('radius').value),
        days_back: parseInt(document.getElementById('daysBack').value)
    };

    // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
    const radius = params.radius;
    const days = params.days_back;
    showLoading(
        `æ­£åœ¨æŸ¥è¯¢åŒºåŸŸé¸Ÿè®¯...`,
        `æ­£åœ¨æœç´¢åŠå¾„ ${radius} km èŒƒå›´å†…ï¼Œæœ€è¿‘ ${days} å¤©çš„é¸Ÿç±»è§‚æµ‹è®°å½•...`
    );

    try {
        const data = await apiRequest('/api/region_query', {
            method: 'POST',
            body: JSON.stringify(params)
        });

        if (data.success) {
            // ä¿å­˜æŸ¥è¯¢ç»“æœæ•°æ®ï¼ˆç”¨äºåœ°å›¾æ˜¾ç¤ºï¼‰
            queryResultData = data;

            // æ˜¾ç¤ºç»“æœæ‘˜è¦
            const message = `æŸ¥è¯¢å®Œæˆï¼æ‰¾åˆ° ${data.species_count} ç§é¸Ÿç±»ï¼Œå…± ${data.observations_count} æ¡è§‚æµ‹è®°å½•`;
            showNotification(message, 'success');

            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            const resultsArea = document.getElementById('resultsArea');
            const resultsContent = document.getElementById('resultsContent');

            resultsContent.innerHTML = `
                <div class="result-summary">
                    <div class="summary-card">
                        <div class="summary-icon"><i class="bi bi-check-circle-fill"></i></div>
                        <div class="summary-content">
                            <h3>åŒºåŸŸæŸ¥è¯¢æˆåŠŸ</h3>
                            <div class="summary-stats">
                                <div class="stat-item">
                                    <span class="stat-label">é¸Ÿç§æ•°é‡</span>
                                    <span class="stat-value">${data.species_count}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">è§‚æµ‹è®°å½•</span>
                                    <span class="stat-value">${data.observations_count}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">è§‚æµ‹åœ°ç‚¹</span>
                                    <span class="stat-value">${data.unique_locations}</span>
                                </div>
                            </div>
                            <p class="summary-note">
                                <i class="bi bi-check-circle-fill"></i>
                                <strong>æŠ¥å‘Šå·²ç”Ÿæˆï¼š</strong> ${data.report_file}
                            </p>
                            <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center;">
                                <a href="/reports" class="btn btn-primary">
                                    <i class="bi bi-folder-fill"></i> æŸ¥çœ‹æ‰€æœ‰æŠ¥å‘Š
                                </a>
                                <button onclick="viewReport('${data.report_path}')" class="btn btn-secondary">
                                    <i class="bi bi-eye-fill"></i> é¢„è§ˆæŠ¥å‘Š
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            resultsArea.style.display = 'block';

            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            resultsArea.scrollIntoView({ behavior: 'smooth' });

        } else {
            showNotification(data.message || 'æœªæ‰¾åˆ°è§‚æµ‹è®°å½•', 'warning');
        }
    } catch (error) {
        // Error already handled
    } finally {
        // éšè—åŠ è½½åŠ¨ç”»
        hideLoading();
    }
}

function resetForm() {
    document.getElementById('placeName').value = '';
    document.getElementById('coordsString').value = '';
    document.getElementById('latitude').value = '';
    document.getElementById('longitude').value = '';
    document.getElementById('parsedCoords').style.display = 'none';
    document.getElementById('placeVerifyResult').style.display = 'none';
    document.getElementById('adminCountrySelect').value = '';
    document.getElementById('adminRegionSelect').innerHTML = '<option value="">-- è¯·å…ˆé€‰æ‹©å›½å®¶ --</option>';
    document.getElementById('adminRegionSelectGroup').style.display = 'none';
    document.getElementById('radius').value = 25;
    document.getElementById('daysBack').value = 14;
    updateRadiusDisplay(25);
    switchInputMethod('place');
}

// éªŒè¯åœ°ç‚¹åç§°
async function verifyPlaceName() {
    const placeName = document.getElementById('placeName').value.trim();
    const resultDiv = document.getElementById('placeVerifyResult');

    if (!placeName) {
        showNotification('è¯·è¾“å…¥åœ°ç‚¹åç§°', 'warning');
        return;
    }

    try {
        showNotification('æ­£åœ¨éªŒè¯åœ°å€...', 'info');

        const data = await apiRequest('/api/geocode', {
            method: 'POST',
            body: JSON.stringify({ place_name: placeName })
        });

        if (data.success) {
            // æ˜¾ç¤ºéªŒè¯æˆåŠŸç»“æœ
            document.getElementById('verifiedPlaceAddress').textContent = data.display_name;
            document.getElementById('verifiedPlaceCoords').textContent =
                `${data.latitude.toFixed(4)}, ${data.longitude.toFixed(4)}`;

            resultDiv.querySelector('.alert').className = 'alert alert-success';
            resultDiv.querySelector('strong').innerHTML = '<i class="bi bi-check-circle"></i> åœ°å€éªŒè¯æˆåŠŸ';
            resultDiv.style.display = 'block';

            showNotification('åœ°å€éªŒè¯æˆåŠŸ', 'success');
        } else {
            // æ˜¾ç¤ºéªŒè¯å¤±è´¥
            resultDiv.querySelector('.alert').className = 'alert alert-error';
            resultDiv.querySelector('.alert').innerHTML =
                `<strong><i class="bi bi-x-circle"></i> åœ°å€éªŒè¯å¤±è´¥</strong><br>${data.error}`;
            resultDiv.style.display = 'block';
        }
    } catch (error) {
        // Error already handled by apiRequest
        resultDiv.style.display = 'none';
    }
}

// æŸ¥çœ‹æŠ¥å‘Šï¼ˆè·³è½¬åˆ°ç»“æœé¡µé¢ï¼‰
function viewReport(reportPath) {
    // è·³è½¬åˆ°ç»“æœé¡µé¢è¿›è¡Œåœ¨çº¿é¢„è§ˆ
    window.location.href = `/result/${reportPath}`;
}

// åŠ è½½æ‰€æœ‰å›½å®¶åˆ—è¡¨
async function loadCountries() {
    try {
        const data = await apiRequest('/api/ebird/countries');

        if (data.success && data.countries) {
            const select = document.getElementById('adminCountrySelect');
            const topCount = data.top_endemic_count || 20;

            data.countries.forEach((country, index) => {
                const displayName = country.name_zh || country.name_en;
                const option = document.createElement('option');
                option.value = country.code;

                // å‰20åæ˜¾ç¤ºç‰¹æœ‰ç§æ•°é‡å’Œç‰¹æ®Šæ ‡è®°
                if (index < topCount && country.endemic_count > 0) {
                    option.textContent = `ğŸŒŸ ${displayName} (${country.code}) - ${country.endemic_count}ç§ç‰¹æœ‰é¸Ÿ`;
                    option.style.fontWeight = 'bold';
                } else {
                    option.textContent = `${displayName} (${country.code})`;
                }

                select.appendChild(option);

                // åœ¨ç¬¬20ä¸ªä¹‹åæ·»åŠ åˆ†éš”çº¿
                if (index === topCount - 1) {
                    const separator = document.createElement('option');
                    separator.disabled = true;
                    separator.textContent = 'â”€â”€â”€â”€â”€â”€â”€ å…¶ä»–å›½å®¶ï¼ˆæŒ‰å­—æ¯æ’åºï¼‰ â”€â”€â”€â”€â”€â”€â”€';
                    separator.style.textAlign = 'center';
                    separator.style.fontStyle = 'italic';
                    separator.style.color = '#999';
                    select.appendChild(separator);
                }
            });

            console.log(`å·²åŠ è½½ ${data.countries.length} ä¸ªå›½å®¶ï¼ˆå‰${topCount}åæŒ‰ç‰¹æœ‰ç§æ’åºï¼‰`);
        }
    } catch (error) {
        console.error('åŠ è½½å›½å®¶åˆ—è¡¨å¤±è´¥:', error);
    }
}

// æ ¹æ®å›½å®¶åŠ è½½åŒºåŸŸåˆ—è¡¨
async function loadAdminRegions() {
    const countryCode = document.getElementById('adminCountrySelect').value;
    const regionSelectGroup = document.getElementById('adminRegionSelectGroup');
    const regionSelect = document.getElementById('adminRegionSelect');

    if (!countryCode) {
        regionSelectGroup.style.display = 'none';
        regionSelect.innerHTML = '<option value="">-- è¯·å…ˆé€‰æ‹©å›½å®¶ --</option>';
        return;
    }

    try {
        const data = await apiRequest(`/api/ebird/regions/${countryCode}`);

        if (data.success) {
            regionSelect.innerHTML = '';

            // æ·»åŠ "ä¸é™"é€‰é¡¹ï¼ˆä½¿ç”¨å›½å®¶ä¸­å¿ƒç‚¹ï¼‰
            const wholeCountryOption = document.createElement('option');
            wholeCountryOption.value = '';
            wholeCountryOption.textContent = 'ä¸é™åŒºåŸŸï¼ˆä½¿ç”¨å›½å®¶ä¸­å¿ƒç‚¹ï¼‰';
            regionSelect.appendChild(wholeCountryOption);

            // æ·»åŠ å„åŒºåŸŸ
            if (data.regions && data.regions.length > 0) {
                data.regions.forEach(region => {
                    const displayName = region.name_zh || region.name_en;
                    const option = document.createElement('option');
                    option.value = region.code;
                    option.textContent = displayName;
                    regionSelect.appendChild(option);
                });

                regionSelectGroup.style.display = 'block';
            } else {
                // è¯¥å›½å®¶æ²¡æœ‰ä¸‹çº§åŒºåŸŸ
                regionSelectGroup.style.display = 'none';
            }
        }
    } catch (error) {
        console.error('åŠ è½½åŒºåŸŸåˆ—è¡¨å¤±è´¥:', error);
    }
}

// é¡µé¢åŠ è½½æ—¶è·å–å›½å®¶åˆ—è¡¨
document.addEventListener('DOMContentLoaded', async function() {
    await loadCountries();
});
</script>
{% endblock %}
