{% extends "base.html" %}

{% block title %}ç‰¹æœ‰ç§æ£€ç´¢ - æ…§çœ¼æ‰¾é¸Ÿ{% endblock %}

{% block content %}
<div class="endemic-container">
    <h1 class="page-title">
        <i class="bi bi-globe2"></i> å…¨çƒç‰¹æœ‰ç§æ£€ç´¢
    </h1>

    <div class="endemic-card">
        <p class="intro-text">
            <i class="bi bi-info-circle"></i>
            å·²æ”¶å½•å…¨çƒ 108 ä¸ªå›½å®¶çš„ 3,183 ç§ç‰¹æœ‰é¸Ÿç±»æ•°æ®ï¼ŒæŒ‰å¤§æ´²åˆ†ç»„å±•ç¤º
        </p>

        <!-- æœç´¢æ¡† -->
        <div class="search-section">
            <div class="search-box">
                <input type="text"
                       id="countrySearch"
                       class="form-control"
                       placeholder="ğŸ” æœç´¢å›½å®¶ï¼ˆä¸­æ–‡ã€è‹±æ–‡æˆ–ä»£ç ï¼Œä¾‹å¦‚ï¼šä¸­å›½ã€CNã€Australiaï¼‰"
                       oninput="filterCountries(this.value)">
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-bar">
            <div class="stat-item">
                <i class="bi bi-globe-americas"></i>
                <span class="stat-value" id="totalCountries">108</span>
                <span class="stat-label">ä¸ªå›½å®¶</span>
            </div>
            <div class="stat-item">
                <i class="bi bi-star-fill"></i>
                <span class="stat-value">3,183</span>
                <span class="stat-label">ç§ç‰¹æœ‰é¸Ÿ</span>
            </div>
            <div class="stat-item">
                <i class="bi bi-eye-fill"></i>
                <span class="stat-value" id="visibleCountries">108</span>
                <span class="stat-label">æ˜¾ç¤ºä¸­</span>
            </div>
        </div>

        <!-- æŒ‰æ´²åˆ†ç»„çš„å›½å®¶åˆ—è¡¨ -->
        <div id="continentsContainer" class="continents-container">
            <div class="loading-spinner">
                <i class="bi bi-hourglass-split"></i> åŠ è½½ä¸­...
            </div>
        </div>
    </div>
</div>

<!-- å›½å®¶è¯¦æƒ…å¼¹çª— -->
<div id="countryModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalCountryTitle"></h2>
            <button class="modal-close" onclick="closeModal()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- æ¨¡æ€çª—å£å†…çš„æœç´¢å’Œæ§åˆ¶ -->
            <div class="modal-controls">
                <input type="text"
                       id="modalBirdSearch"
                       class="form-control"
                       placeholder="ğŸ” æœç´¢é¸Ÿåï¼ˆä¸­æ–‡æˆ–è‹±æ–‡ï¼‰"
                       oninput="filterModalBirds(this.value)">
                <div class="modal-actions">
                    <button onclick="selectAllModalBirds()" class="btn btn-sm btn-secondary">
                        <i class="bi bi-check-all"></i> å…¨é€‰
                    </button>
                    <button onclick="clearModalSelection()" class="btn btn-sm btn-secondary">
                        <i class="bi bi-x-circle"></i> æ¸…ç©º
                    </button>
                    <span id="modalSelectionCount" class="selection-count">å·²é€‰æ‹© 0 ç§</span>
                </div>
            </div>
            <div id="modalBirdsContent" class="modal-birds-list"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">
                <i class="bi bi-x-circle"></i> å…³é—­
            </button>
            <button class="btn btn-primary" onclick="goToTracking()">
                <i class="bi bi-binoculars-fill"></i> è¿½è¸ªå·²é€‰é¸Ÿç§
            </button>
        </div>
    </div>
</div>

<style>
.endemic-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 1rem;
}

.page-title {
    font-size: 2.5rem;
    margin-bottom: 2rem;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 1rem;
}

.endemic-card {
    background: var(--card-bg);
    padding: 2rem;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
}

.intro-text {
    background: linear-gradient(135deg, #e3f2fd, #f0f4ff);
    padding: 1rem 1.5rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    color: var(--text-dark);
    border-left: 4px solid var(--secondary-color);
}

.search-section {
    margin-bottom: 1.5rem;
}

.search-box {
    width: 100%;
}

.search-box .form-control {
    width: 100%;
    font-size: 1.1rem;
    padding: 0.75rem 1rem;
}

.stats-bar {
    display: flex;
    gap: 2rem;
    justify-content: center;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, #ffffff, #f8f9fa);
    border-radius: 10px;
    border: 2px solid var(--border-color);
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
}

.stat-item i {
    font-size: 2rem;
    color: var(--primary-color);
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
}

.stat-label {
    font-size: 0.9rem;
    color: var(--text-light);
}

.continents-container {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.continent-section {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    border: 2px solid var(--border-color);
    transition: var(--transition);
}

.continent-section.hidden {
    display: none;
}

.continent-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--border-color);
}

.continent-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.continent-title i {
    font-size: 1.8rem;
}

.continent-stats {
    display: flex;
    gap: 1.5rem;
    font-size: 0.9rem;
    color: var(--text-light);
}

.continent-stats span {
    display: flex;
    align-items: center;
    gap: 0.3rem;
}

.countries-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
}

.country-tag {
    background: linear-gradient(135deg, #ffffff, #f8f9fa);
    padding: 0.75rem 1.25rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    white-space: nowrap;
}

.country-tag:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: var(--secondary-color);
    background: linear-gradient(135deg, #e3f2fd, #f0f4ff);
}

.country-tag.hidden {
    display: none;
}

.country-tag-name {
    font-weight: 600;
    color: var(--text-dark);
}

.country-tag-count {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 0.25rem 0.6rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
}

/* æ¨¡æ€çª—å£æ ·å¼ */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
}

.modal-content {
    background: white;
    width: 90%;
    max-width: 900px;
    max-height: 85vh;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    padding: 1.5rem 2rem;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border-radius: 16px 16px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.8rem;
}

.modal-close {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    font-size: 1.5rem;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
}

.modal-close:hover {
    background: rgba(255,255,255,0.3);
    transform: rotate(90deg);
}

.modal-body {
    padding: 2rem;
    overflow-y: auto;
    flex: 1;
}

.modal-controls {
    margin-bottom: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.modal-controls .form-control {
    width: 100%;
}

.modal-actions {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.selection-count {
    margin-left: auto;
    font-weight: 600;
    color: var(--primary-color);
    padding: 0.5rem 1rem;
    background: #e3f2fd;
    border-radius: 20px;
}

.modal-birds-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
    max-height: 400px;
    overflow-y: auto;
}

.modal-bird-item {
    background: linear-gradient(135deg, #ffffff, #f8f9fa);
    padding: 1rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    transition: var(--transition);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.modal-bird-item:hover {
    border-color: var(--secondary-color);
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

.modal-bird-item.selected {
    border-color: var(--primary-color);
    background: linear-gradient(135deg, #e3f2fd, #f0f4ff);
}

.modal-bird-item.hidden {
    display: none;
}

.modal-bird-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
    flex-shrink: 0;
}

.modal-bird-info {
    flex: 1;
    min-width: 0;
}

.bird-name-cn {
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.3rem;
}

.bird-name-en {
    font-size: 0.85rem;
    color: var(--text-light);
}

.modal-footer {
    padding: 1.5rem 2rem;
    background: #f8f9fa;
    border-radius: 0 0 16px 16px;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    border-top: 1px solid var(--border-color);
}

.loading-spinner {
    text-align: center;
    padding: 3rem;
    color: var(--text-light);
    font-size: 1.2rem;
}

@media (max-width: 768px) {
    .stats-bar {
        flex-direction: column;
        gap: 1rem;
    }

    .continent-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .countries-grid {
        gap: 0.5rem;
    }

    .country-tag {
        padding: 0.6rem 1rem;
    }

    .modal-birds-list {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let countriesData = [];
let currentCountryData = null;
let selectedModalBirds = new Set();

// å¤§æ´²é…ç½®
const CONTINENT_CONFIG = {
    'Asia': { name: 'äºšæ´²', icon: 'bi-globe-asia-australia' },
    'Europe': { name: 'æ¬§æ´²', icon: 'bi-globe-europe-africa' },
    'Africa': { name: 'éæ´²', icon: 'bi-globe-europe-africa' },
    'North America': { name: 'åŒ—ç¾æ´²', icon: 'bi-globe-americas' },
    'South America': { name: 'å—ç¾æ´²', icon: 'bi-globe-americas' },
    'Oceania': { name: 'å¤§æ´‹æ´²', icon: 'bi-globe-asia-australia' },
    'Antarctica': { name: 'å—ææ´²', icon: 'bi-snow' }
};

// é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
document.addEventListener('DOMContentLoaded', async function() {
    await loadCountriesByContinent();
});

async function loadCountriesByContinent() {
    try {
        const data = await apiRequest('/api/endemic/countries-by-continent');

        if (data.success && data.continents) {
            countriesData = data.continents;
            renderContinents(countriesData);
            updateStats();
        }
    } catch (error) {
        document.getElementById('continentsContainer').innerHTML =
            '<div class="error-message"><i class="bi bi-exclamation-triangle"></i> åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
    }
}

function renderContinents(continents) {
    const container = document.getElementById('continentsContainer');

    if (!continents || Object.keys(continents).length === 0) {
        container.innerHTML = '<p class="text-muted">æš‚æ— æ•°æ®</p>';
        return;
    }

    // æŒ‰ç…§æŒ‡å®šé¡ºåºæ’åˆ—å¤§æ´²
    const continentOrder = ['Asia', 'Europe', 'Africa', 'North America', 'South America', 'Oceania', 'Antarctica'];

    container.innerHTML = continentOrder
        .filter(continent => continents[continent] && continents[continent].length > 0)
        .map(continent => {
            const config = CONTINENT_CONFIG[continent] || { name: continent, icon: 'bi-globe' };
            const countries = continents[continent];
            const totalSpecies = countries.reduce((sum, c) => sum + c.endemic_count, 0);

            return `
                <div class="continent-section" data-continent="${continent}">
                    <div class="continent-header">
                        <div class="continent-title">
                            <i class="${config.icon}"></i>
                            ${config.name}
                        </div>
                        <div class="continent-stats">
                            <span><i class="bi bi-flag"></i> ${countries.length} ä¸ªå›½å®¶</span>
                            <span><i class="bi bi-star-fill"></i> ${totalSpecies} ç§ç‰¹æœ‰é¸Ÿ</span>
                        </div>
                    </div>
                    <div class="countries-grid">
                        ${countries.map(country => {
                            const displayName = country.country_name_zh || country.country_name_en;
                            return `
                                <div class="country-tag"
                                     data-country-code="${country.country_code}"
                                     data-search-text="${displayName} ${country.country_name_en} ${country.country_code}"
                                     onclick="loadCountryDetails('${country.country_code}')">
                                    <span class="country-tag-name">${displayName}</span>
                                    <span class="country-tag-count">${country.endemic_count}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }).join('');
}

function filterCountries(searchTerm) {
    searchTerm = searchTerm.toLowerCase().trim();

    const allCountries = document.querySelectorAll('.country-tag');
    const allContinents = document.querySelectorAll('.continent-section');

    let visibleCount = 0;

    if (!searchTerm) {
        // æ˜¾ç¤ºæ‰€æœ‰
        allCountries.forEach(tag => tag.classList.remove('hidden'));
        allContinents.forEach(section => section.classList.remove('hidden'));
        visibleCount = allCountries.length;
    } else {
        // è¿‡æ»¤
        allCountries.forEach(tag => {
            const searchText = tag.dataset.searchText.toLowerCase();
            if (searchText.includes(searchTerm)) {
                tag.classList.remove('hidden');
                visibleCount++;
            } else {
                tag.classList.add('hidden');
            }
        });

        // éšè—æ²¡æœ‰å¯è§å›½å®¶çš„æ´²
        allContinents.forEach(section => {
            const visibleCountries = section.querySelectorAll('.country-tag:not(.hidden)');
            if (visibleCountries.length === 0) {
                section.classList.add('hidden');
            } else {
                section.classList.remove('hidden');
            }
        });
    }

    document.getElementById('visibleCountries').textContent = visibleCount;
}

function updateStats() {
    const totalCount = document.querySelectorAll('.country-tag').length;
    document.getElementById('totalCountries').textContent = totalCount;
    document.getElementById('visibleCountries').textContent = totalCount;
}

async function loadCountryDetails(countryCode) {
    try {
        console.log('ğŸ” ç‚¹å‡»çš„å›½å®¶ä»£ç :', countryCode);
        showNotification(`æ­£åœ¨åŠ è½½ ${countryCode} çš„ç‰¹æœ‰é¸Ÿç§...`, 'info');

        const apiUrl = `/api/endemic-birds/${encodeURIComponent(countryCode)}`;
        console.log('ğŸ“¡ APIè¯·æ±‚URL:', apiUrl);

        const data = await apiRequest(apiUrl);
        console.log('âœ… APIè¿”å›æ•°æ®:', data);

        if (data.success) {
            console.log('ğŸ“Š å›½å®¶ä¿¡æ¯:', data.country);
            console.log('ğŸ¦ é¸Ÿç§æ•°é‡:', data.birds.length);
            currentCountryData = data;
            showCountryModal(data);
        }
    } catch (error) {
        console.error('âŒ åŠ è½½å¤±è´¥:', error);
    }
}

function showCountryModal(data) {
    console.log('æ˜¾ç¤ºå›½å®¶æ¨¡æ€çª—å£:', data);

    const modal = document.getElementById('countryModal');
    const displayName = data.country.country_name_zh || data.country.country_name_en;

    // é‡ç½®é€‰æ‹©çŠ¶æ€
    selectedModalBirds.clear();
    document.getElementById('modalBirdSearch').value = '';

    document.getElementById('modalCountryTitle').innerHTML =
        `<i class="bi bi-flag-fill"></i> ${displayName} - ${data.total_species} ç§ç‰¹æœ‰é¸Ÿ`;

    const birdsListHtml = data.birds.map((bird, index) => `
        <div class="modal-bird-item" data-index="${index}">
            <input type="checkbox"
                   class="modal-bird-checkbox"
                   id="modal-bird-${index}">
            <div class="modal-bird-info">
                <div class="bird-name-cn">${bird.cn_name}</div>
                <div class="bird-name-en">${bird.en_name}</div>
            </div>
        </div>
    `).join('');

    document.getElementById('modalBirdsContent').innerHTML = birdsListHtml;
    updateModalSelectionCount();

    console.log('âœ… å…±æ¸²æŸ“äº†', data.birds.length, 'ä¸ªé¸Ÿç§é¡¹');

    // ä¸ºæ¯ä¸ªé¸Ÿç§é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
    const items = document.querySelectorAll('.modal-bird-item');
    console.log('ğŸ” æ‰¾åˆ°', items.length, 'ä¸ª modal-bird-item å…ƒç´ ');

    items.forEach(item => {
        const index = parseInt(item.dataset.index);
        console.log('ğŸ¯ ä¸ºç¬¬', index, 'ä¸ªé¸Ÿç§æ·»åŠ äº‹ä»¶ç›‘å¬');

        // ç‚¹å‡»å¡ç‰‡åˆ‡æ¢é€‰æ‹©
        item.addEventListener('click', function(e) {
            console.log('ğŸ‘† ç‚¹å‡»äº†é¸Ÿç§å¡ç‰‡', index, 'ç›®æ ‡å…ƒç´ :', e.target.className);
            // å¦‚æœç‚¹å‡»çš„æ˜¯å¤é€‰æ¡†,ä¸å¤„ç†ï¼ˆè®©å¤é€‰æ¡†è‡ªå·±å¤„ç†ï¼‰
            if (e.target.classList.contains('modal-bird-checkbox')) {
                console.log('â­ï¸  ç‚¹å‡»çš„æ˜¯å¤é€‰æ¡†ï¼Œè·³è¿‡å¡ç‰‡å¤„ç†');
                return;
            }
            toggleModalBirdSelection(index);
        });

        // å¤é€‰æ¡†å˜åŒ–äº‹ä»¶
        const checkbox = item.querySelector('.modal-bird-checkbox');
        if (checkbox) {
            console.log('âœ… æ‰¾åˆ°å¤é€‰æ¡† ID:', checkbox.id);
            checkbox.addEventListener('change', function(e) {
                console.log('â˜‘ï¸  å¤é€‰æ¡†çŠ¶æ€æ”¹å˜:', index, 'æ–°çŠ¶æ€:', e.target.checked);
                e.stopPropagation();
                toggleModalBirdSelection(index);
            });
        } else {
            console.error('âŒ æ²¡æœ‰æ‰¾åˆ°å¤é€‰æ¡†ï¼Œindex:', index);
        }
    });

    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
}

function closeModal() {
    document.getElementById('countryModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    selectedModalBirds.clear();
}

function toggleModalBirdSelection(index) {
    console.log('ğŸ”„ toggleModalBirdSelection è¢«è°ƒç”¨ï¼Œindex:', index);

    const checkbox = document.getElementById(`modal-bird-${index}`);
    console.log('ğŸ“Œ æŸ¥æ‰¾å¤é€‰æ¡†:', `modal-bird-${index}`, 'ç»“æœ:', checkbox);

    if (!checkbox) {
        console.error('âŒ æ²¡æœ‰æ‰¾åˆ°å¤é€‰æ¡†ï¼');
        return;
    }

    const item = checkbox.closest('.modal-bird-item');
    console.log('ğŸ“¦ æŸ¥æ‰¾çˆ¶å…ƒç´  modal-bird-item:', item);

    if (!item) {
        console.error('âŒ æ²¡æœ‰æ‰¾åˆ°çˆ¶å…ƒç´ ï¼');
        return;
    }

    if (selectedModalBirds.has(index)) {
        console.log('â– å–æ¶ˆé€‰æ‹©ç¬¬', index, 'ä¸ªé¸Ÿç§');
        selectedModalBirds.delete(index);
        checkbox.checked = false;
        item.classList.remove('selected');
    } else {
        console.log('â• é€‰æ‹©ç¬¬', index, 'ä¸ªé¸Ÿç§');
        selectedModalBirds.add(index);
        checkbox.checked = true;
        item.classList.add('selected');
    }

    console.log('ğŸ“Š å½“å‰é€‰æ‹©çš„é¸Ÿç§:', Array.from(selectedModalBirds));
    updateModalSelectionCount();
}

function selectAllModalBirds() {
    const visibleBirds = document.querySelectorAll('.modal-bird-item:not(.hidden)');

    visibleBirds.forEach((item) => {
        const index = parseInt(item.dataset.index);
        selectedModalBirds.add(index);
        item.querySelector('.modal-bird-checkbox').checked = true;
        item.classList.add('selected');
    });

    updateModalSelectionCount();
    showNotification(`å·²é€‰æ‹© ${selectedModalBirds.size} ç§é¸Ÿ`, 'success');
}

function clearModalSelection() {
    selectedModalBirds.clear();

    document.querySelectorAll('.modal-bird-checkbox').forEach(checkbox => {
        checkbox.checked = false;
        checkbox.parentElement.classList.remove('selected');
    });

    updateModalSelectionCount();
    showNotification('å·²æ¸…ç©ºé€‰æ‹©', 'info');
}

function filterModalBirds(searchTerm) {
    const items = document.querySelectorAll('.modal-bird-item');

    if (!searchTerm.trim()) {
        items.forEach(item => item.classList.remove('hidden'));
        return;
    }

    items.forEach(item => {
        const cnName = item.querySelector('.bird-name-cn').textContent;
        const enName = item.querySelector('.bird-name-en').textContent;

        if (cnName.includes(searchTerm) || enName.toLowerCase().includes(searchTerm.toLowerCase())) {
            item.classList.remove('hidden');
        } else {
            item.classList.add('hidden');
        }
    });
}

function updateModalSelectionCount() {
    const countSpan = document.getElementById('modalSelectionCount');
    if (countSpan) {
        countSpan.textContent = `å·²é€‰æ‹© ${selectedModalBirds.size} ç§`;
    }
}

function goToTracking() {
    if (!currentCountryData) return;

    // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†é¸Ÿç§
    if (selectedModalBirds.size === 0) {
        showNotification('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§é¸Ÿå†è¿›è¡Œè¿½è¸ª', 'warning');
        return;
    }

    // è·å–é€‰ä¸­çš„é¸Ÿç§
    const birdsToTrack = Array.from(selectedModalBirds).map(index => currentCountryData.birds[index].cn_name);

    // å‡†å¤‡ä¼ é€’çš„æ•°æ®
    const trackingData = {
        birds: birdsToTrack,
        country: currentCountryData.country.country_name_zh || currentCountryData.country.country_name_en,
        countryEn: currentCountryData.country.country_name_en,
        countryCode: currentCountryData.country.country_code,
        fromEndemic: true
    };

    // ä¿å­˜åˆ° localStorage
    localStorage.setItem('endemicTrackingData', JSON.stringify(trackingData));

    showNotification(`æ­£åœ¨è·³è½¬åˆ°è¿½è¸ªé¡µé¢ï¼Œè¿½è¸ª ${birdsToTrack.length} ç§é¸Ÿ...`, 'success');

    setTimeout(() => {
        window.location.href = '/tracker';
    }, 500);
}

// ç‚¹å‡»æ¨¡æ€çª—å£å¤–éƒ¨å…³é—­
document.getElementById('countryModal')?.addEventListener('click', function(e) {
    if (e.target.id === 'countryModal') {
        closeModal();
    }
});

// ESCé”®å…³é—­æ¨¡æ€çª—å£
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
    }
});
</script>
{% endblock %}
