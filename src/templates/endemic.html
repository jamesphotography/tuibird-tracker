{% extends "base.html" %}

{% block title %}ç‰¹æœ‰ç§æ£€ç´¢ - æ…§çœ¼æ‰¾é¸Ÿ{% endblock %}

{% block content %}
<div class="endemic-container">
    <h1 class="page-title">
        <i class="bi bi-globe2"></i> ç‰¹æœ‰ç§æ£€ç´¢
    </h1>

    <div class="endemic-card">
        <p class="intro-text">
            <i class="bi bi-info-circle"></i>
            æœç´¢å…¨çƒå„ä¸ªå›½å®¶çš„ç‰¹æœ‰é¸Ÿç§ï¼Œäº†è§£ä¸åŒåœ°åŒºçš„ç‹¬ç‰¹é¸Ÿç±»èµ„æº
        </p>

        <!-- å›½å®¶é€‰æ‹© -->
        <div class="country-selection">
            <h3><i class="bi bi-flag-fill"></i> é€‰æ‹©å›½å®¶</h3>

            <!-- æœç´¢æ¡† -->
            <div class="form-group">
                <label class="form-label">å›½å®¶åç§°ï¼ˆä¸­æ–‡æˆ–è‹±æ–‡ï¼‰</label>
                <div class="search-box">
                    <input type="text"
                           id="countrySearch"
                           class="form-control"
                           placeholder="ä¾‹å¦‚: ä¸­å›½ã€Australiaã€å°åº¦å°¼è¥¿äºš"
                           oninput="filterCountries(this.value)">
                    <i class="bi bi-search search-icon"></i>
                </div>
                <small class="text-muted">
                    <i class="bi bi-lightbulb"></i>
                    å·²æ”¶å½• <span id="totalCountries">--</span> ä¸ªå›½å®¶çš„ç‰¹æœ‰é¸Ÿç§æ•°æ®
                </small>
            </div>

            <!-- å›½å®¶åˆ—è¡¨ -->
            <div id="countryList" class="country-list">
                <div class="loading-spinner">
                    <i class="bi bi-hourglass-split"></i> åŠ è½½ä¸­...
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-panel" id="statsPanel" style="display: none;">
            <h3><i class="bi bi-bar-chart-fill"></i> ç‰¹æœ‰ç§æ•°é‡æ’è¡Œ</h3>
            <div id="statsContent"></div>
        </div>
    </div>

    <!-- ç»“æœæ˜¾ç¤º -->
    <div id="resultsArea" style="display: none;">
        <div class="results-header">
            <h2 id="countryTitle"></h2>
            <p id="countrySubtitle"></p>
        </div>

        <div class="birds-list-container">
            <div class="list-controls">
                <input type="text"
                       id="birdFilter"
                       class="form-control"
                       placeholder="ğŸ” æœç´¢é¸Ÿåï¼ˆä¸­æ–‡æˆ–è‹±æ–‡ï¼‰"
                       oninput="filterBirds(this.value)">
                <div class="view-options">
                    <button onclick="selectAllBirds()" class="btn btn-sm btn-secondary">
                        <i class="bi bi-check-all"></i> å…¨é€‰
                    </button>
                    <button onclick="clearSelection()" class="btn btn-sm btn-secondary">
                        <i class="bi bi-x-circle"></i> æ¸…ç©º
                    </button>
                    <button onclick="startTracking()" class="btn btn-sm btn-primary">
                        <i class="bi bi-binoculars-fill"></i> è¿½è¸ªå·²é€‰é¸Ÿç§
                    </button>
                </div>
            </div>

            <div id="birdsListContent" class="birds-list"></div>
        </div>
    </div>
</div>

<style>
.endemic-container {
    max-width: 1200px;
    margin: 0 auto;
}

.page-title {
    font-size: 2.5rem;
    margin-bottom: 2rem;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 1rem;
}

.endemic-card {
    background: var(--card-bg);
    padding: 2rem;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    margin-bottom: 2rem;
}

.intro-text {
    background: linear-gradient(135deg, #e3f2fd, #f0f4ff);
    padding: 1rem 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    color: var(--text-dark);
    border-left: 4px solid var(--secondary-color);
}

.country-selection h3,
.stats-panel h3 {
    font-size: 1.3rem;
    margin-bottom: 1.5rem;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.search-box {
    position: relative;
}

.search-box .search-icon {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light);
    font-size: 1.2rem;
    pointer-events: none;
}

.country-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
    margin-top: 1.5rem;
    max-height: 500px;
    overflow-y: auto;
}

.country-item {
    background: white;
    padding: 1.25rem;
    border: 2px solid var(--border-color);
    border-radius: 10px;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.country-item:hover {
    border-color: var(--secondary-color);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.country-item.hidden {
    display: none;
}

.country-info {
    flex: 1;
}

.country-name-cn {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.3rem;
}

.country-name-en {
    font-size: 0.9rem;
    color: var(--text-light);
}

.endemic-count {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9rem;
    white-space: nowrap;
}

.stats-panel {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border-color);
}

.stats-content {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.results-header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-md);
}

.results-header h2 {
    margin: 0 0 0.5rem 0;
    font-size: 2rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.results-header p {
    margin: 0;
    font-size: 1.1rem;
    opacity: 0.95;
}

.birds-list-container {
    background: var(--card-bg);
    padding: 2rem;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
}

.list-controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.list-controls .form-control {
    flex: 1;
    min-width: 250px;
}

.view-options {
    display: flex;
    gap: 0.5rem;
}

.birds-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1rem;
    max-height: 600px;
    overflow-y: auto;
}

.bird-item {
    background: white;
    padding: 1rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: var(--transition);
    cursor: pointer;
}

.bird-item:hover {
    border-color: var(--secondary-color);
    background: #f8f9fa;
}

.bird-item.selected {
    border-color: var(--primary-color);
    background: #e3f2fd;
}

.bird-item.hidden {
    display: none;
}

.bird-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.bird-info-box {
    flex: 1;
    min-width: 0;
}

.bird-name-cn {
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.2rem;
}

.bird-name-en {
    font-size: 0.85rem;
    color: var(--text-light);
}

.loading-spinner {
    text-align: center;
    padding: 3rem;
    color: var(--text-light);
    font-size: 1.2rem;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.country-item,
.bird-item {
    animation: fadeIn 0.3s ease-in-out;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let allCountries = [];
let currentBirds = [];
let selectedBirds = new Set();

// é¡µé¢åŠ è½½æ—¶è·å–å›½å®¶åˆ—è¡¨
document.addEventListener('DOMContentLoaded', async function() {
    await loadCountries();
});

async function loadCountries() {
    try {
        const data = await apiRequest('/api/countries');

        if (data.success) {
            allCountries = data.countries;
            renderCountries(allCountries);

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('totalCountries').textContent = data.total;

            // æ˜¾ç¤ºæ’è¡Œæ¦œ
            renderStats(allCountries.slice(0, 5));
        }
    } catch (error) {
        document.getElementById('countryList').innerHTML =
            '<div class="error-message"><i class="bi bi-exclamation-triangle"></i> åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
    }
}

function renderCountries(countries) {
    const listDiv = document.getElementById('countryList');

    if (countries.length === 0) {
        listDiv.innerHTML = '<p class="text-muted">æœªæ‰¾åˆ°åŒ¹é…çš„å›½å®¶</p>';
        return;
    }

    listDiv.innerHTML = countries.map(country => `
        <div class="country-item" onclick="loadEndemicBirds('${country.country_name_cn}')">
            <div class="country-info">
                <div class="country-name-cn">${country.country_name_cn}</div>
                <div class="country-name-en">${country.country_name_en}</div>
            </div>
            <div class="endemic-count">
                ${country.endemic_count} ç§
            </div>
        </div>
    `).join('');
}

function filterCountries(searchTerm) {
    if (!searchTerm.trim()) {
        renderCountries(allCountries);
        return;
    }

    const filtered = allCountries.filter(country =>
        country.country_name_cn.includes(searchTerm) ||
        country.country_name_en.toLowerCase().includes(searchTerm.toLowerCase())
    );

    renderCountries(filtered);
}

function renderStats(topCountries) {
    const statsContent = document.getElementById('statsContent');
    const statsPanel = document.getElementById('statsPanel');

    statsContent.innerHTML = topCountries.map((country, index) => `
        <div style="flex: 1; min-width: 200px; text-align: center; padding: 1rem; background: white; border-radius: 8px; border: 2px solid var(--border-color);">
            <div style="font-size: 2rem; font-weight: bold; color: var(--primary-color);">#${index + 1}</div>
            <div style="font-weight: 600; margin: 0.5rem 0;">${country.country_name_cn}</div>
            <div style="color: var(--text-light);">${country.endemic_count} ç§</div>
        </div>
    `).join('');

    statsPanel.style.display = 'block';
}

async function loadEndemicBirds(countryName) {
    try {
        showNotification(`æ­£åœ¨åŠ è½½ ${countryName} çš„ç‰¹æœ‰é¸Ÿç§...`, 'info');

        const data = await apiRequest(`/api/endemic-birds/${encodeURIComponent(countryName)}`);

        if (data.success) {
            currentBirds = data.birds;
            selectedBirds.clear();

            // æ›´æ–°æ ‡é¢˜
            document.getElementById('countryTitle').innerHTML =
                `<i class="bi bi-flag-fill"></i> ${data.country.country_name_cn} (${data.country.country_name_en})`;
            document.getElementById('countrySubtitle').textContent =
                `å…±æœ‰ ${data.total_species} ç§ç‰¹æœ‰é¸Ÿç±»`;

            // æ¸²æŸ“é¸Ÿç§åˆ—è¡¨
            renderBirds(currentBirds);

            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            document.getElementById('resultsArea').style.display = 'block';

            // æ»šåŠ¨åˆ°ç»“æœ
            document.getElementById('resultsArea').scrollIntoView({ behavior: 'smooth' });

            showNotification(`åŠ è½½æˆåŠŸï¼æ‰¾åˆ° ${data.total_species} ç§ç‰¹æœ‰é¸Ÿ`, 'success');
        }
    } catch (error) {
        // Error already handled
    }
}

function renderBirds(birds) {
    const listDiv = document.getElementById('birdsListContent');

    if (birds.length === 0) {
        listDiv.innerHTML = '<p class="text-muted">æœªæ‰¾åˆ°é¸Ÿç§</p>';
        return;
    }

    listDiv.innerHTML = birds.map((bird, index) => `
        <div class="bird-item" data-index="${index}" onclick="toggleBirdSelection(${index})">
            <input type="checkbox"
                   class="bird-checkbox"
                   id="bird-${index}"
                   onchange="event.stopPropagation(); toggleBirdSelection(${index})">
            <div class="bird-info-box">
                <div class="bird-name-cn">${bird.cn_name}</div>
                <div class="bird-name-en">${bird.en_name}</div>
            </div>
        </div>
    `).join('');
}

function toggleBirdSelection(index) {
    const checkbox = document.getElementById(`bird-${index}`);
    const item = checkbox.parentElement;

    if (selectedBirds.has(index)) {
        selectedBirds.delete(index);
        checkbox.checked = false;
        item.classList.remove('selected');
    } else {
        selectedBirds.add(index);
        checkbox.checked = true;
        item.classList.add('selected');
    }
}

function selectAllBirds() {
    const visibleBirds = document.querySelectorAll('.bird-item:not(.hidden)');

    visibleBirds.forEach((item) => {
        const index = parseInt(item.dataset.index);
        selectedBirds.add(index);
        item.querySelector('.bird-checkbox').checked = true;
        item.classList.add('selected');
    });

    showNotification(`å·²é€‰æ‹© ${selectedBirds.size} ç§é¸Ÿ`, 'success');
}

function clearSelection() {
    selectedBirds.clear();

    document.querySelectorAll('.bird-checkbox').forEach(checkbox => {
        checkbox.checked = false;
        checkbox.parentElement.classList.remove('selected');
    });

    showNotification('å·²æ¸…ç©ºé€‰æ‹©', 'info');
}

function filterBirds(searchTerm) {
    const items = document.querySelectorAll('.bird-item');

    if (!searchTerm.trim()) {
        items.forEach(item => item.classList.remove('hidden'));
        return;
    }

    items.forEach(item => {
        const cnName = item.querySelector('.bird-name-cn').textContent;
        const enName = item.querySelector('.bird-name-en').textContent;

        if (cnName.includes(searchTerm) || enName.toLowerCase().includes(searchTerm.toLowerCase())) {
            item.classList.remove('hidden');
        } else {
            item.classList.add('hidden');
        }
    });
}

function startTracking() {
    if (selectedBirds.size === 0) {
        showNotification('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§é¸Ÿ', 'warning');
        return;
    }

    // è·å–é€‰ä¸­çš„é¸Ÿç§åç§°
    const selectedBirdNames = Array.from(selectedBirds).map(index => {
        return currentBirds[index].cn_name;
    });

    // å°†é€‰ä¸­çš„é¸Ÿç§åç§°ä¿å­˜åˆ° localStorage
    localStorage.setItem('preselectedBirds', JSON.stringify(selectedBirdNames));

    showNotification(`å·²é€‰æ‹© ${selectedBirds.size} ç§é¸Ÿï¼Œæ­£åœ¨è·³è½¬åˆ°è¿½è¸ªé¡µé¢...`, 'success');

    // è·³è½¬åˆ°è¿½è¸ªé¡µé¢
    setTimeout(() => {
        window.location.href = '/tracker';
    }, 500);
}
</script>
{% endblock %}
