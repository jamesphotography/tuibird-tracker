function showLoading(mainText='正在查询中...',subText='请稍候，正在从eBird数据库获取数据'){const overlay=document.getElementById('loadingOverlay');const loadingText=document.getElementById('loadingText');const loadingSubtext=document.getElementById('loadingSubtext');if(overlay){if(loadingText)loadingText.textContent=mainText;if(loadingSubtext)loadingSubtext.textContent=subText;overlay.classList.add('active');document.body.style.overflow='hidden';}}
function hideLoading(){const overlay=document.getElementById('loadingOverlay');if(overlay){overlay.classList.remove('active');document.body.style.overflow='';}}
function showNotification(message,type='info'){const notification=document.createElement('div');notification.className=`notification notification-${type}`;const messageSpan=document.createElement('span');messageSpan.textContent=message;messageSpan.style.cssText='flex: 1; word-wrap: break-word;';const closeBtn=document.createElement('button');closeBtn.innerHTML='×';closeBtn.style.cssText=`
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        margin-left: 1rem;
        line-height: 1;
        opacity: 0.8;
    `;closeBtn.onmouseover=()=>closeBtn.style.opacity='1';closeBtn.onmouseout=()=>closeBtn.style.opacity='0.8';closeBtn.onclick=()=>removeNotification(notification);notification.appendChild(messageSpan);notification.appendChild(closeBtn);notification.style.cssText=`
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 9999;
        animation: slideIn 0.3s ease;
        max-width: 500px;
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
    `;const colors={'success':'#27AE60','error':'#E74C3C','warning':'#F39C12','info':'#4A90E2'};notification.style.background=colors[type]||colors.info;notification.style.color='white';document.body.appendChild(notification);if(type==='error'||type==='warning'){notification.setAttribute('data-persistent','true');}else{setTimeout(()=>{removeNotification(notification);},5000);}}
function removeNotification(notification){if(notification&&notification.parentElement){notification.style.animation='slideOut 0.3s ease';setTimeout(()=>{if(notification.parentElement){document.body.removeChild(notification);}},300);}}
function getLocalApiKey(){return localStorage.getItem('ebird_api_key');}
function saveLocalApiKey(apiKey){localStorage.setItem('ebird_api_key',apiKey);const expires=new Date();expires.setFullYear(expires.getFullYear()+1);document.cookie=`ebird_api_key=${apiKey}; expires=${expires.toUTCString()}; path=/; SameSite=Lax`;}
function removeLocalApiKey(){localStorage.removeItem('ebird_api_key');document.cookie='ebird_api_key=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';}
async function apiRequest(url,options={}){try{const apiKey=getLocalApiKey();const response=await fetch(url,{...options,headers:{'Content-Type':'application/json',...(apiKey&&{'X-eBird-API-Key':apiKey}),'X-CSRFToken':csrfToken,...options.headers}});const data=await response.json();if(!response.ok){throw new Error(data.error||'请求失败');}
return data;}catch(error){console.error('API Error:',error);showNotification(error.message,'error');throw error;}}
function formatDateTime(dateString){if(!dateString)return'未知';const date=new Date(dateString);return date.toLocaleString('zh-CN');}
function debounce(func,wait){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args);};clearTimeout(timeout);timeout=setTimeout(later,wait);};}
document.addEventListener('DOMContentLoaded',function(){const apiKey=getLocalApiKey();if(apiKey){const cookieApiKey=document.cookie.split('; ').find(row=>row.startsWith('ebird_api_key='))?.split('=')[1];if(!cookieApiKey||cookieApiKey!==apiKey){saveLocalApiKey(apiKey);}}
const style=document.createElement('style');style.textContent=`
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;document.head.appendChild(style);});